<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"edward.org.cn","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="packages\SystemUI\src\com\android\systemui\statusbar\tablet\TabletStatusBar.java &#x2F;*  * Copyright (C) 2010 The Android Open Source Project  *  * Licensed under the Apache License, Version 2.0 (the &amp;quo">
<meta property="og:type" content="article">
<meta property="og:title" content="TabletStatusBar">
<meta property="og:url" content="http://edward.org.cn/2020/12/31/%E7%83%82%E7%AC%94%E5%A4%B4/TabletStatusBar.java/index.html">
<meta property="og:site_name" content="点点滴滴">
<meta property="og:description" content="packages\SystemUI\src\com\android\systemui\statusbar\tablet\TabletStatusBar.java &#x2F;*  * Copyright (C) 2010 The Android Open Source Project  *  * Licensed under the Apache License, Version 2.0 (the &amp;quo">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-12-31T06:48:01.693Z">
<meta property="article:modified_time" content="2020-01-16T04:37:32.901Z">
<meta property="article:author" content="Edward">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://edward.org.cn/2020/12/31/%E7%83%82%E7%AC%94%E5%A4%B4/TabletStatusBar.java/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>TabletStatusBar | 点点滴滴</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a92ed22eafce466e7a7b17546bb0dc6f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">点点滴滴</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://edward.org.cn/2020/12/31/%E7%83%82%E7%AC%94%E5%A4%B4/TabletStatusBar.java/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.gif">
      <meta itemprop="name" content="Edward">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="点点滴滴">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          TabletStatusBar
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-31 14:48:01" itemprop="dateCreated datePublished" datetime="2020-12-31T14:48:01+08:00">2020-12-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-01-16 12:37:32" itemprop="dateModified" datetime="2020-01-16T12:37:32+08:00">2020-01-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%83%82%E7%AC%94%E5%A4%B4/" itemprop="url" rel="index"><span itemprop="name">烂笔头</span></a>
                </span>
            </span>

          
            <span id="/2020/12/31/%E7%83%82%E7%AC%94%E5%A4%B4/TabletStatusBar.java/" class="post-meta-item leancloud_visitors" data-flag-title="TabletStatusBar" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>packages\SystemUI\src\com\android\systemui\statusbar\tablet\TabletStatusBar.java</p>
<p>/*</p>
<p> * Copyright (C) 2010 The Android Open Source Project</p>
<p> *</p>
<p> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</p>
<p> * you may not use this file except in compliance with the License.</p>
<p> * You may obtain a copy of the License at</p>
<p> *</p>
<p> *      <a target="_blank" rel="noopener" href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
<p> *</p>
<p> * Unless required by applicable law or agreed to in writing, software</p>
<p> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</p>
<p> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</p>
<p> * See the License for the specific language governing permissions and</p>
<p> * limitations under the License.</p>
<p> */</p>
<p>package com.android.systemui.statusbar.tablet;</p>
<p>import android.animation.LayoutTransition;</p>
<p>import android.animation.ObjectAnimator;</p>
<p>import android.app.ActivityManager;</p>
<p>import android.app.ActivityManagerNative;</p>
<p>import android.app.Notification;</p>
<p>import android.app.PendingIntent;</p>
<p>import android.app.StatusBarManager;</p>
<p>import android.content.BroadcastReceiver;</p>
<p>import android.content.Context;</p>
<p>import android.content.Intent;</p>
<p>import android.content.IntentFilter;</p>
<p>import android.content.SharedPreferences;</p>
<p>import android.content.res.Configuration;</p>
<p>import android.content.res.Resources;</p>
<p>import android.graphics.PixelFormat;</p>
<p>import android.graphics.Point;</p>
<p>import android.graphics.drawable.Drawable;</p>
<p>import android.graphics.drawable.LayerDrawable;</p>
<p>import android.inputmethodservice.InputMethodService;</p>
<p>import android.os.IBinder;</p>
<p>import android.os.Message;</p>
<p>import android.os.RemoteException;</p>
<p>import android.os.ServiceManager;</p>
<p>import android.text.TextUtils;</p>
<p>import android.util.Slog;</p>
<p>import android.view.Display;</p>
<p>import android.view.Gravity;</p>
<p>import android.view.IWindowManager;</p>
<p>import android.view.KeyEvent;</p>
<p>import android.view.MotionEvent;</p>
<p>import android.view.SoundEffectConstants;</p>
<p>import android.view.VelocityTracker;</p>
<p>import android.view.View;</p>
<p>import android.view.ViewConfiguration;</p>
<p>import android.view.ViewGroup;</p>
<p>import android.view.ViewGroup.LayoutParams;</p>
<p>import android.view.WindowManager;</p>
<p>import android.view.WindowManagerImpl;</p>
<p>import android.view.accessibility.AccessibilityEvent;</p>
<p>import android.widget.ImageView;</p>
<p>import android.widget.LinearLayout;</p>
<p>import android.widget.RemoteViews;</p>
<p>import android.widget.ScrollView;</p>
<p>import android.widget.TextView;</p>
<p>import android.os.SystemProperties;</p>
<p>import com.android.internal.statusbar.StatusBarIcon;</p>
<p>import com.android.internal.statusbar.StatusBarNotification;</p>
<p>import com.android.systemui.R;</p>
<p>import com.android.systemui.recent.RecentTasksLoader;</p>
<p>import com.android.systemui.recent.RecentsPanelView;</p>
<p>import com.android.systemui.statusbar.BaseStatusBar;</p>
<p>import com.android.systemui.statusbar.CommandQueue;</p>
<p>import com.android.systemui.statusbar.DoNotDisturb;</p>
<p>import com.android.systemui.statusbar.NotificationData;</p>
<p>import com.android.systemui.statusbar.SignalClusterView;</p>
<p>import com.android.systemui.statusbar.StatusBarIconView;</p>
<p>import com.android.systemui.statusbar.NotificationData.Entry;</p>
<p>import com.android.systemui.statusbar.policy.BatteryController;</p>
<p>import com.android.systemui.statusbar.policy.BluetoothController;</p>
<p>import com.android.systemui.statusbar.policy.CompatModeButton;</p>
<p>import com.android.systemui.statusbar.policy.LocationController;</p>
<p>import com.android.systemui.statusbar.policy.NetworkController;</p>
<p>import com.android.systemui.statusbar.policy.NotificationRowLayout;</p>
<p>import com.android.systemui.statusbar.policy.Prefs;</p>
<p>import android.os.storage.StorageManager;</p>
<p>import com.android.internal.statusbar.StatusBarNotification;</p>
<p>import java.io.FileDescriptor;</p>
<p>import java.io.PrintWriter;</p>
<p>import java.util.ArrayList;</p>
<p>import android.content.ServiceConnection;</p>
<p>import android.content.ComponentName;</p>
<p>import android.os.Messenger;</p>
<p>import android.content.BroadcastReceiver;</p>
<p>import android.content.Intent;</p>
<p>import android.content.IntentFilter;</p>
<p>import android.util.Log;</p>
<p>import android.os.Handler;</p>
<p>import android.provider.Settings;</p>
<p>import java.io.File;</p>
<p>import android.widget.Toast;</p>
<p>public class TabletStatusBar extends BaseStatusBar implements</p>
<p>        InputMethodsPanel.OnHardKeyboardEnabledChangeListener,</p>
<p>        RecentsPanelView.OnRecentsPanelVisibilityChangedListener {</p>
<p>    public static final boolean DEBUG = false;</p>
<p>    public static final boolean DEBUG_COMPAT_HELP = false;</p>
<p>    public static final String TAG = &quot;TabletStatusBar&quot;;</p>
<p>    public static  boolean HIDE_TABLET_STATUSBAR=false;</p>
<p>    public static final int MSG_OPEN_NOTIFICATION_PANEL = 1000;</p>
<p>    public static final int MSG_CLOSE_NOTIFICATION_PANEL = 1001;</p>
<p>    public static final int MSG_OPEN_NOTIFICATION_PEEK = 1002;</p>
<p>    public static final int MSG_CLOSE_NOTIFICATION_PEEK = 1003;</p>
<p>    // 1020-1029 reserved for BaseStatusBar</p>
<p>    public static final int MSG_SHOW_CHROME = 1030;</p>
<p>    public static final int MSG_HIDE_CHROME = 1031;</p>
<p>    public static final int MSG_OPEN_INPUT_METHODS_PANEL = 1040;</p>
<p>    public static final int MSG_CLOSE_INPUT_METHODS_PANEL = 1041;</p>
<p>    public static final int MSG_OPEN_COMPAT_MODE_PANEL = 1050;</p>
<p>    public static final int MSG_CLOSE_COMPAT_MODE_PANEL = 1051;</p>
<p>    public static final int MSG_STOP_TICKER = 2000;</p>
<p>    // Fitts’ Law assistance for LatinIME; see policy.EventHole</p>
<p>    private static final boolean FAKE_SPACE_BAR = true;</p>
<p>    // Notification &quot;peeking&quot; (flyover preview of individual notifications)</p>
<p>    final static int NOTIFICATION_PEEK_HOLD_THRESH = 200; // ms</p>
<p>    final static int NOTIFICATION_PEEK_FADE_DELAY = 3000; // ms</p>
<p>    private static final int NOTIFICATION_PRIORITY_MULTIPLIER = 10; // see NotificationManagerService</p>
<p>    private static final int HIDE_ICONS_BELOW_SCORE = Notification.PRIORITY_LOW * NOTIFICATION_PRIORITY_MULTIPLIER;</p>
<p>    // The height of the bar, as definied by the build.  It may be taller if we’re plugged</p>
<p>    // into hdmi.</p>
<p>    int mNaturalBarHeight = -1;</p>
<p>    int mIconSize = -1;</p>
<p>    int mIconHPadding = -1;</p>
<p>    int mNavIconWidth = -1;</p>
<p>    int mMenuNavIconWidth = -1;</p>
<p>    private int mMaxNotificationIcons = 5;</p>
<p>    IWindowManager mWindowManager;</p>
<p>  // storage</p>
<p>    private StorageManager mStorageManager;</p>
<p>    TabletStatusBarView mStatusBarView;</p>
<p>    View mNotificationArea;</p>
<p>    View mNotificationTrigger;</p>
<p>    NotificationIconArea mNotificationIconArea;</p>
<p>    ViewGroup mNavigationArea;</p>
<p>    boolean mNotificationDNDMode;</p>
<p>    NotificationData.Entry mNotificationDNDDummyEntry;</p>
<p>    ImageView mBackButton;</p>
<p>    View mHomeButton;</p>
<p>    View mMenuButton;</p>
<p>    View mRecentButton;</p>
<p>    View mVolumeUpButton;</p>
<p>    View mVolumeDownButton;</p>
<p>    private boolean mAltBackButtonEnabledForIme;</p>
<p>    ViewGroup mFeedbackIconArea; // notification icons, IME icon, compat icon</p>
<p>    InputMethodButton mInputMethodSwitchButton;</p>
<p>    CompatModeButton mCompatModeButton;</p>
<p>    ImageView mScreenshot;</p>
<p>    NotificationPanel mNotificationPanel;</p>
<p>    WindowManager.LayoutParams mNotificationPanelParams;</p>
<p>    NotificationPeekPanel mNotificationPeekWindow;</p>
<p>    ViewGroup mNotificationPeekRow;</p>
<p>    int mNotificationPeekIndex;</p>
<p>    IBinder mNotificationPeekKey;</p>
<p>    LayoutTransition mNotificationPeekScrubLeft, mNotificationPeekScrubRight;</p>
<p>    int mNotificationPeekTapDuration;</p>
<p>    int mNotificationFlingVelocity;</p>
<p>    BatteryController mBatteryController;</p>
<p>    BluetoothController mBluetoothController;</p>
<p>    LocationController mLocationController;</p>
<p>    NetworkController mNetworkController;</p>
<p>    DoNotDisturb mDoNotDisturb;</p>
<p>    ViewGroup mBarContents;</p>
<p>    // hide system chrome (&quot;lights out&quot;) support</p>
<p>    View mShadow;</p>
<p>    NotificationIconArea.IconLayout mIconLayout;</p>
<p>    TabletTicker mTicker;</p>
<p>    View mFakeSpaceBar;</p>
<p>    KeyEvent mSpaceBarKeyEvent = null;</p>
<p>    View mCompatibilityHelpDialog = null;</p>
<p>    // for disabling the status bar</p>
<p>    int mDisabled = 0;</p>
<p>    private InputMethodsPanel mInputMethodsPanel;</p>
<p>    private CompatModePanel mCompatModePanel;</p>
<p>    private int mSystemUiVisibility = 0;</p>
<p>    private int mNavigationIconHints = 0;</p>
<p>    private int mShowSearchHoldoff = 0;</p>
<p>private String isEnableShowVoiceIcon = SystemProperties.get(&quot;ro.rk.systembar.voiceicon&quot;);</p>
<p>    public Context getContext() { return mContext; }</p>
<p>    private Runnable mShowSearchPanel = new Runnable() {</p>
<p>        public void run() {</p>
<p>            showSearchPanel();</p>
<p>        }</p>
<p>    };</p>
<p>    private View.OnTouchListener mHomeSearchActionListener = new View.OnTouchListener() {</p>
<p>        public boolean onTouch(View v, MotionEvent event) {</p>
<p>            switch(event.getAction()) {</p>
<p>                case MotionEvent.ACTION_DOWN:</p>
<p>                    if (!shouldDisableNavbarGestures() &amp;&amp; !inKeyguardRestrictedInputMode()) {</p>
<p>                        mHandler.removeCallbacks(mShowSearchPanel);</p>
<p>                        mHandler.postDelayed(mShowSearchPanel, mShowSearchHoldoff);</p>
<p>                    }</p>
<p>                break;</p>
<p>                case MotionEvent.ACTION_UP:</p>
<p>                case MotionEvent.ACTION_CANCEL:</p>
<p>                    mHandler.removeCallbacks(mShowSearchPanel);</p>
<p>                break;</p>
<p>            }</p>
<p>            return false;</p>
<p>        }</p>
<p>    };</p>
<p>    @Override</p>
<p>    protected void createAndAddWindows() {</p>
<p>        addStatusBarWindow();</p>
<p>        addPanelWindows();</p>
<p>    }</p>
<p>    private void addStatusBarWindow() {</p>
<p>        final View sb = makeStatusBarView();</p>
<p>        final WindowManager.LayoutParams lp = new WindowManager.LayoutParams(</p>
<p>                ViewGroup.LayoutParams.MATCH_PARENT,</p>
<p>                ViewGroup.LayoutParams.MATCH_PARENT,</p>
<p>                WindowManager.LayoutParams.TYPE_NAVIGATION_BAR,</p>
<p>                WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE</p>
<p>                    | WindowManager.LayoutParams.FLAG_TOUCHABLE_WHEN_WAKING</p>
<p>                    | WindowManager.LayoutParams.FLAG_SPLIT_TOUCH,</p>
<p>                // We use a pixel format of RGB565 for the status bar to save memory bandwidth and</p>
<p>                // to ensure that the layer can be handled by HWComposer.  On some devices the</p>
<p>                // HWComposer is unable to handle SW-rendered RGBX_8888 layers.</p>
<p>                PixelFormat.RGB_565);</p>
<p>        // We explicitly leave FLAG_HARDWARE_ACCELERATED out of the flags.  The status bar occupies</p>
<p>        // very little screen real-estate and is updated fairly frequently.  By using CPU rendering</p>
<p>        // for the status bar, we prevent the GPU from having to wake up just to do these small</p>
<p>        // updates, which should help keep power consumption down.</p>
<p>        lp.gravity = getStatusBarGravity();</p>
<p>        lp.setTitle(&quot;SystemBar&quot;);</p>
<p>        lp.packageName = mContext.getPackageName();</p>
<p>        WindowManagerImpl.getDefault().addView(sb, lp);</p>
<p>    }</p>
<p>    protected void addPanelWindows() {</p>
<p>        final Context context = mContext;</p>
<p>        final Resources res = mContext.getResources();</p>
<p>        // Notification Panel</p>
<p>        mNotificationPanel = (NotificationPanel)View.inflate(context,</p>
<p>                R.layout.system_bar_notification_panel, null);</p>
<p>        mNotificationPanel.setBar(this);</p>
<p>        mNotificationPanel.show(false, false);</p>
<p>        mNotificationPanel.setOnTouchListener(</p>
<p>                new TouchOutsideListener(MSG_CLOSE_NOTIFICATION_PANEL, mNotificationPanel));</p>
<p>        // the battery icon</p>
<p>        mBatteryController.addIconView((ImageView)mNotificationPanel.findViewById(R.id.battery));</p>
<p>        mBatteryController.addLabelView(</p>
<p>                (TextView)mNotificationPanel.findViewById(R.id.battery_text));</p>
<p>        // Bt</p>
<p>        mBluetoothController.addIconView(</p>
<p>                (ImageView)mNotificationPanel.findViewById(R.id.bluetooth));</p>
<p>        // network icons: either a combo icon that switches between mobile and data, or distinct</p>
<p>        // mobile and data icons</p>
<p>        final ImageView mobileRSSI =</p>
<p>                (ImageView)mNotificationPanel.findViewById(R.id.mobile_signal);</p>
<p>        if (mobileRSSI != null) {</p>
<p>            mNetworkController.addPhoneSignalIconView(mobileRSSI);</p>
<p>        }</p>
<p>        final ImageView wifiRSSI =</p>
<p>                (ImageView)mNotificationPanel.findViewById(R.id.wifi_signal);</p>
<p>        if (wifiRSSI != null) {</p>
<p>            mNetworkController.addWifiIconView(wifiRSSI);</p>
<p>        }</p>
<p>        mNetworkController.addWifiLabelView(</p>
<p>                (TextView)mNotificationPanel.findViewById(R.id.wifi_text));</p>
<p>        mNetworkController.addDataTypeIconView(</p>
<p>                (ImageView)mNotificationPanel.findViewById(R.id.mobile_type));</p>
<p>        mNetworkController.addMobileLabelView(</p>
<p>                (TextView)mNotificationPanel.findViewById(R.id.mobile_text));</p>
<p>        mNetworkController.addCombinedLabelView(</p>
<p>                (TextView)mBarContents.findViewById(R.id.network_text));</p>
<p>        mStatusBarView.setIgnoreChildren(0, mNotificationTrigger, mNotificationPanel);</p>
<p>        WindowManager.LayoutParams lp = mNotificationPanelParams = new WindowManager.LayoutParams(</p>
<p>                res.getDimensionPixelSize(R.dimen.notification_panel_width),</p>
<p>                getNotificationPanelHeight(),</p>
<p>                WindowManager.LayoutParams.TYPE_NAVIGATION_BAR_PANEL,</p>
<p>                WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN</p>
<p>                    | WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS</p>
<p>                    | WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM</p>
<p>                    | WindowManager.LayoutParams.FLAG_SPLIT_TOUCH</p>
<p>                    | WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED,</p>
<p>                PixelFormat.TRANSLUCENT);</p>
<p>        lp.gravity = Gravity.BOTTOM | Gravity.RIGHT;</p>
<p>        lp.setTitle(&quot;NotificationPanel&quot;);</p>
<p>        lp.softInputMode = WindowManager.LayoutParams.SOFT_INPUT_STATE_UNCHANGED</p>
<p>                | WindowManager.LayoutParams.SOFT_INPUT_ADJUST_NOTHING;</p>
<p>        lp.windowAnimations = com.android.internal.R.style.Animation; // == no animation</p>
<p>//        lp.windowAnimations = com.android.internal.R.style.Animation_ZoomButtons; // simple fade</p>
<p>        WindowManagerImpl.getDefault().addView(mNotificationPanel, lp);</p>
<p>        // Recents Panel</p>
<p>        mRecentTasksLoader = new RecentTasksLoader(context);</p>
<p>        updateRecentsPanel();</p>
<p>        // Search Panel</p>
<p>        mStatusBarView.setBar(this);</p>
<p>        mHomeButton.setOnTouchListener(mHomeSearchActionListener);</p>
<p>        updateSearchPanel();</p>
<p>        // Input methods Panel</p>
<p>        mInputMethodsPanel = (InputMethodsPanel) View.inflate(context,</p>
<p>                R.layout.system_bar_input_methods_panel, null);</p>
<p>        mInputMethodsPanel.setHardKeyboardEnabledChangeListener(this);</p>
<p>        mInputMethodsPanel.setOnTouchListener(new TouchOutsideListener(</p>
<p>                MSG_CLOSE_INPUT_METHODS_PANEL, mInputMethodsPanel));</p>
<p>        mInputMethodsPanel.setImeSwitchButton(mInputMethodSwitchButton);</p>
<p>        mStatusBarView.setIgnoreChildren(2, mInputMethodSwitchButton, mInputMethodsPanel);</p>
<p>        lp = new WindowManager.LayoutParams(</p>
<p>                ViewGroup.LayoutParams.WRAP_CONTENT,</p>
<p>                ViewGroup.LayoutParams.WRAP_CONTENT,</p>
<p>                WindowManager.LayoutParams.TYPE_STATUS_BAR_PANEL,</p>
<p>                WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN</p>
<p>                    | WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM</p>
<p>                    | WindowManager.LayoutParams.FLAG_SPLIT_TOUCH</p>
<p>                    | WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED,</p>
<p>                PixelFormat.TRANSLUCENT);</p>
<p>        lp.gravity = Gravity.BOTTOM | Gravity.RIGHT;</p>
<p>        lp.setTitle(&quot;InputMethodsPanel&quot;);</p>
<p>        lp.windowAnimations = R.style.Animation_RecentPanel;</p>
<p>        WindowManagerImpl.getDefault().addView(mInputMethodsPanel, lp);</p>
<p>        // Compatibility mode selector panel</p>
<p>        mCompatModePanel = (CompatModePanel) View.inflate(context,</p>
<p>                R.layout.system_bar_compat_mode_panel, null);</p>
<p>        mCompatModePanel.setOnTouchListener(new TouchOutsideListener(</p>
<p>                MSG_CLOSE_COMPAT_MODE_PANEL, mCompatModePanel));</p>
<p>        mCompatModePanel.setTrigger(mCompatModeButton);</p>
<p>        mCompatModePanel.setVisibility(View.GONE);</p>
<p>        mStatusBarView.setIgnoreChildren(3, mCompatModeButton, mCompatModePanel);</p>
<p>        lp = new WindowManager.LayoutParams(</p>
<p>                250,</p>
<p>                ViewGroup.LayoutParams.WRAP_CONTENT,</p>
<p>                WindowManager.LayoutParams.TYPE_STATUS_BAR_PANEL,</p>
<p>                WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN</p>
<p>                    | WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM</p>
<p>                    | WindowManager.LayoutParams.FLAG_SPLIT_TOUCH</p>
<p>                    | WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED,</p>
<p>                PixelFormat.TRANSLUCENT);</p>
<p>        lp.gravity = Gravity.BOTTOM | Gravity.RIGHT;</p>
<p>        lp.setTitle(&quot;CompatModePanel&quot;);</p>
<p>        lp.windowAnimations = android.R.style.Animation_Dialog;</p>
<p>        WindowManagerImpl.getDefault().addView(mCompatModePanel, lp);</p>
<p>        mRecentButton.setOnTouchListener(mRecentsPanel);</p>
<p>        mPile = (NotificationRowLayout)mNotificationPanel.findViewById(R.id.content);</p>
<p>        mPile.removeAllViews();</p>
<p>        mPile.setLongPressListener(getNotificationLongClicker());</p>
<p>        ScrollView scroller = (ScrollView)mPile.getParent();</p>
<p>        scroller.setFillViewport(true);</p>
<p>    }</p>
<p>    @Override</p>
<p>    protected int getExpandedViewMaxHeight() {</p>
<p>        return getNotificationPanelHeight();</p>
<p>    }</p>
<p>    private int getNotificationPanelHeight() {</p>
<p>        final Resources res = mContext.getResources();</p>
<p>        final Display d = WindowManagerImpl.getDefault().getDefaultDisplay();</p>
<p>        final Point size = new Point();</p>
<p>        d.getRealSize(size);</p>
<p>        return Math.max(res.getDimensionPixelSize(R.dimen.notification_panel_min_height), size.y);</p>
<p>    }</p>
<p>    @Override</p>
<p>    public void start() {</p>
<p>        super.start(); // will add the main bar view</p>
<p> mStorageManager = (StorageManager) mContext.getSystemService(Context.STORAGE_SERVICE);</p>
<p>     mStorageManager.registerListener(new com.android.systemui.usb.StorageNotification(mContext));</p>
<p>    }</p>
<p>    @Override</p>
<p>    protected void onConfigurationChanged(Configuration newConfig) {</p>
<p>        loadDimens();</p>
<p>if(&quot;true&quot;.equals(isEnableShowVoiceIcon)){</p>
<p>if ((mDisabled &amp; (StatusBarManager.DISABLE_RECENT</p>
<p>| StatusBarManager.DISABLE_BACK</p>
<p>| StatusBarManager.DISABLE_HOME)) == 0) {</p>
<p>if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) { </p>
<p>mVolumeUpButton.setVisibility(View.VISIBLE);</p>
<p>mVolumeDownButton.setVisibility(View.VISIBLE);</p>
<p>}else {</p>
<p>mVolumeUpButton.setVisibility(View.GONE);</p>
<p>mVolumeDownButton.setVisibility(View.GONE);</p>
<p>}</p>
<p>}</p>
<p>if (newConfig.orientation != Configuration.ORIENTATION_LANDSCAPE) { </p>
<p>mVolumeUpButton.setVisibility(View.GONE);</p>
<p>mVolumeDownButton.setVisibility(View.GONE);</p>
<p>}</p>
<p>}</p>
<p>        mNotificationPanelParams.height = getNotificationPanelHeight();</p>
<p>        WindowManagerImpl.getDefault().updateViewLayout(mNotificationPanel,</p>
<p>                mNotificationPanelParams);</p>
<p>        mRecentsPanel.updateValuesFromResources();</p>
<p>        mShowSearchHoldoff = mContext.getResources().getInteger(</p>
<p>                R.integer.config_show_search_delay);</p>
<p>        updateSearchPanel();</p>
<p>    }</p>
<p>    protected void loadDimens() {</p>
<p>        final Resources res = mContext.getResources();</p>
<p>        mNaturalBarHeight = res.getDimensionPixelSize(</p>
<p>                com.android.internal.R.dimen.navigation_bar_height);</p>
<p>        int newIconSize = res.getDimensionPixelSize(</p>
<p>            com.android.internal.R.dimen.system_bar_icon_size);</p>
<p>        int newIconHPadding = res.getDimensionPixelSize(</p>
<p>            R.dimen.status_bar_icon_padding);</p>
<p>        int newNavIconWidth = res.getDimensionPixelSize(R.dimen.navigation_key_width);</p>
<p>        int newMenuNavIconWidth = res.getDimensionPixelSize(R.dimen.navigation_menu_key_width);</p>
<p>        if (mNavigationArea != null &amp;&amp; newNavIconWidth != mNavIconWidth) {</p>
<p>            mNavIconWidth = newNavIconWidth;</p>
<p>            LinearLayout.LayoutParams lp = new LinearLayout.LayoutParams(</p>
<p>                     mNavIconWidth, ViewGroup.LayoutParams.MATCH_PARENT);</p>
<p>            mBackButton.setLayoutParams(lp);</p>
<p>            mHomeButton.setLayoutParams(lp);</p>
<p>            mRecentButton.setLayoutParams(lp);</p>
<p>            mVolumeUpButton.setLayoutParams(lp);</p>
<p>            mVolumeDownButton.setLayoutParams(lp);</p>
<p>        }</p>
<p>        if (mNavigationArea != null &amp;&amp; newMenuNavIconWidth != mMenuNavIconWidth) {</p>
<p>            mMenuNavIconWidth = newMenuNavIconWidth;</p>
<p>            LinearLayout.LayoutParams lp = new LinearLayout.LayoutParams(</p>
<p>                     mMenuNavIconWidth, ViewGroup.LayoutParams.MATCH_PARENT);</p>
<p>            mMenuButton.setLayoutParams(lp);</p>
<p>        }</p>
<p>        if (newIconHPadding != mIconHPadding || newIconSize != mIconSize) {</p>
<p>//            Slog.d(TAG, &quot;size=&quot; + newIconSize + &quot; padding=&quot; + newIconHPadding);</p>
<p>            mIconHPadding = newIconHPadding;</p>
<p>            mIconSize = newIconSize;</p>
<p>            reloadAllNotificationIcons(); // reload the tray</p>
<p>        }</p>
<p>        final int numIcons = res.getInteger(R.integer.config_maxNotificationIcons);</p>
<p>        if (numIcons != mMaxNotificationIcons) {</p>
<p>            mMaxNotificationIcons = numIcons;</p>
<p>            if (DEBUG) Slog.d(TAG, &quot;max notification icons: &quot; + mMaxNotificationIcons);</p>
<p>            reloadAllNotificationIcons();</p>
<p>        }</p>
<p>    }</p>
<p>    final Object mScreenshotLock = new Object();</p>
<p>    ServiceConnection mScreenshotConnection = null;</p>
<p>    final Runnable mScreenshotTimeout = new Runnable() {</p>
<p>        @Override public void run() {</p>
<p>            synchronized (mScreenshotLock) {</p>
<p>                if (mScreenshotConnection != null) {</p>
<p>                    mContext.unbindService(mScreenshotConnection);</p>
<p>                    mScreenshotConnection = null;</p>
<p>                }</p>
<p>            }</p>
<p>        }</p>
<p>    };</p>
<p>    private void takeScreenshot() {</p>
<p>        String imageDir=Settings.System.getString(mContext.getContentResolver(), Settings.System.SCREENSHOT_LOCATION);</p>
<p>        File file=new File(imageDir+&quot;/Screenshots&quot;);</p>
<p>        String text=null;</p>
<p>        file.mkdir();</p>
<p>        if(!file.exists()){</p>
<p>           if(imageDir.equals(&quot;/mnt/sdcard&quot;)||imageDir.equals(&quot;/storage/sdcard0&quot;)){</p>
<p>                text=mContext.getResources().getString(R.string.sdcard_unmount);</p>
<p>           }else if(imageDir.equals(&quot;/mnt/external_sd&quot;)){</p>
<p>                text=mContext.getResources().getString(R.string.external_sd_unmount);  </p>
<p>           }else if(imageDir.equals(&quot;/mnt/usb_storage&quot;)){</p>
<p>                text=mContext.getResources().getString(R.string.usb_storage_unmount);</p>
<p>           }</p>
<p>           Toast.makeText(mContext, text, 3000).show();</p>
<p>           return;</p>
<p>        }</p>
<p>        synchronized (mScreenshotLock) {</p>
<p>            if (mScreenshotConnection != null) {</p>
<p>                return;</p>
<p>            }</p>
<p>            ComponentName cn = new ComponentName(&quot;com.android.systemui&quot;,</p>
<p>                    &quot;com.android.systemui.screenshot.TakeScreenshotService&quot;);</p>
<p>            Intent intent = new Intent();</p>
<p>            intent.setComponent(cn);</p>
<p>            ServiceConnection conn = new ServiceConnection() {</p>
<p>                @Override</p>
<p>                public void onServiceConnected(ComponentName name, IBinder service) {</p>
<p>                    synchronized (mScreenshotLock) {</p>
<p>                        if (mScreenshotConnection != this) {</p>
<p>                            return;</p>
<p>                        }</p>
<p>                        Messenger messenger = new Messenger(service);</p>
<p>                        Message msg = Message.obtain(null, 1);</p>
<p>                        final ServiceConnection myConn = this;</p>
<p>                        Handler h = new Handler(mHandler.getLooper()) {</p>
<p>                            @Override</p>
<p>                            public void handleMessage(Message msg) {</p>
<p>                                synchronized (mScreenshotLock) {</p>
<p>                                    if (mScreenshotConnection == myConn) {</p>
<p>                                        mContext.unbindService(mScreenshotConnection);</p>
<p>                                        mScreenshotConnection = null;</p>
<p>                                        mHandler.removeCallbacks(mScreenshotTimeout);</p>
<p>                                    }</p>
<p>                                }</p>
<p>                            }</p>
<p>                        };</p>
<p>                        msg.replyTo = new Messenger(h);</p>
<p>                        msg.arg1=0;</p>
<p>                        msg.arg2=1;</p>
<p>                       // if (mStatusBar != null &amp;&amp; mStatusBar.isVisibleLw())</p>
<p>                       //     msg.arg1 = 1;</p>
<p>                       // if (mNavigationBar != null &amp;&amp; mNavigationBar.isVisibleLw())</p>
<p>                       //     msg.arg2 = 1;</p>
<p>                        try {</p>
<p>                            messenger.send(msg);</p>
<p>                        } catch (RemoteException e) {</p>
<p>                        }</p>
<p>                    }</p>
<p>                }</p>
<p>                @Override</p>
<p>                public void onServiceDisconnected(ComponentName name) {}</p>
<p>            };</p>
<p>            if (mContext.bindService(intent, conn, Context.BIND_AUTO_CREATE)) {</p>
<p>                mScreenshotConnection = conn;</p>
<p>                mHandler.postDelayed(mScreenshotTimeout, 10000);</p>
<p>            }</p>
<p>        }</p>
<p>    }</p>
<p>    private BroadcastReceiver receiver=new BroadcastReceiver() {</p>
<p>                @Override</p>
<p>                public void onReceive(Context context, Intent intent) {</p>
<p>                        // TODO Auto-generated method stub</p>
<p>                        //Log.d(&quot;screenshot&quot;,&quot;onReceiver&quot;);</p>
<p>                        String action=intent.getAction();</p>
<p>                        Log.d(&quot;screenshot&quot;,action);</p>
<p>                        if(action.equals(&quot;rk.android.screenshot.SHOW&quot;)){</p>
<p>                        boolean show=intent.getBooleanExtra(&quot;show&quot;, false);</p>
<p>                         if(show){</p>
<p>                                 Log.d(&quot;screenshot&quot;,&quot;show screenshot button&quot;);</p>
<p>                                mScreenshot.setVisibility(View.VISIBLE);</p>
<p>                         }else{</p>
<p>                                Log.d(&quot;screenshot&quot;,&quot;disable screenshot button&quot;);</p>
<p>                                mScreenshot.setVisibility(View.GONE);</p>
<p>                         }</p>
<p>                        }else{</p>
<p>                            takeScreenshot();</p>
<p>                        }</p>
<p>                }</p>
<p>        };</p>
<p>    public View getStatusBarView() {</p>
<p>        return mStatusBarView;</p>
<p>    }</p>
<p>    protected View makeStatusBarView() {</p>
<p>        final Context context = mContext;</p>
<p>        IntentFilter intentfilter=new IntentFilter();</p>
<p>        intentfilter.addAction(&quot;rk.android.screenshot.SHOW&quot;);</p>
<p>        intentfilter.addAction(&quot;rk.android.screenshot.ACTION&quot;);</p>
<p>        context.registerReceiver(receiver, intentfilter);</p>
<p>        mWindowManager = IWindowManager.Stub.asInterface(</p>
<p>                ServiceManager.getService(Context.WINDOW_SERVICE));</p>
<p>        loadDimens();</p>
<p>        final TabletStatusBarView sb = (TabletStatusBarView)View.inflate(</p>
<p>                context, R.layout.system_bar, null);</p>
<p>        mStatusBarView = sb;</p>
<p>        sb.setHandler(mHandler);</p>
<p>        try {</p>
<p>            // Sanity-check that someone hasn’t set up the config wrong and asked for a navigation</p>
<p>            // bar on a tablet that has only the system bar</p>
<p>            if (mWindowManager.hasNavigationBar()) {</p>
<p>                Slog.e(TAG, &quot;Tablet device cannot show navigation bar and system bar&quot;);</p>
<p>            }</p>
<p>        } catch (RemoteException ex) {</p>
<p>        }</p>
<p>        mBarContents = (ViewGroup) sb.findViewById(R.id.bar_contents);</p>
<p>        // the whole right-hand side of the bar</p>
<p>        mNotificationArea = sb.findViewById(R.id.notificationArea);</p>
<p>        mNotificationArea.setOnTouchListener(new NotificationTriggerTouchListener());</p>
<p>        // the button to open the notification area</p>
<p>        mNotificationTrigger = sb.findViewById(R.id.notificationTrigger);</p>
<p>        // the more notifications icon</p>
<p>        mNotificationIconArea = (NotificationIconArea)sb.findViewById(R.id.notificationIcons);</p>
<p>        // where the icons go</p>
<p>        mIconLayout = (NotificationIconArea.IconLayout) sb.findViewById(R.id.icons);</p>
<p>        ViewConfiguration vc = ViewConfiguration.get(context);</p>
<p>        mNotificationPeekTapDuration = vc.getTapTimeout();</p>
<p>        mNotificationFlingVelocity = 300; // px/s</p>
<p>        mTicker = new TabletTicker(this);</p>
<p>        // The icons</p>
<p>        mLocationController = new LocationController(mContext); // will post a notification</p>
<p>        // watch the PREF_DO_NOT_DISTURB and convert to appropriate disable() calls</p>
<p>        mDoNotDisturb = new DoNotDisturb(mContext);</p>
<p>        mBatteryController = new BatteryController(mContext);</p>
<p>        mBatteryController.addIconView((ImageView)sb.findViewById(R.id.battery));</p>
<p>        mBluetoothController = new BluetoothController(mContext);</p>
<p>        mBluetoothController.addIconView((ImageView)sb.findViewById(R.id.bluetooth));</p>
<p>        mNetworkController = new NetworkController(mContext);</p>
<p>        final SignalClusterView signalCluster =</p>
<p>                (SignalClusterView)sb.findViewById(R.id.signal_cluster);</p>
<p>        mNetworkController.addSignalCluster(signalCluster);</p>
<p>        // The navigation buttons</p>
<p>        mBackButton = (ImageView)sb.findViewById(R.id.back);</p>
<p>        mNavigationArea = (ViewGroup) sb.findViewById(R.id.navigationArea);</p>
<p>        mHomeButton = mNavigationArea.findViewById(R.id.home);</p>
<p>        mMenuButton = mNavigationArea.findViewById(R.id.menu);</p>
<p>        mRecentButton = mNavigationArea.findViewById(R.id.recent_apps);</p>
<p>        mVolumeUpButton = mNavigationArea.findViewById(R.id.add);</p>
<p>        mVolumeDownButton = mNavigationArea.findViewById(R.id.sub);</p>
<p>        mRecentButton.setOnClickListener(mOnClickListener);</p>
<p>        LayoutTransition lt = new LayoutTransition();</p>
<p>        lt.setDuration(250);</p>
<p>        // don’t wait for these transitions; we just want icons to fade in/out, not move around</p>
<p>        lt.setDuration(LayoutTransition.CHANGE_APPEARING, 0);</p>
<p>        lt.setDuration(LayoutTransition.CHANGE_DISAPPEARING, 0);</p>
<p>        lt.addTransitionListener(new LayoutTransition.TransitionListener() {</p>
<p>            public void endTransition(LayoutTransition transition, ViewGroup container,</p>
<p>                    View view, int transitionType) {</p>
<p>                // ensure the menu button doesn’t stick around on the status bar after it’s been</p>
<p>                // removed</p>
<p>                mBarContents.invalidate();</p>
<p>            }</p>
<p>            public void startTransition(LayoutTransition transition, ViewGroup container,</p>
<p>                    View view, int transitionType) {}</p>
<p>        });</p>
<p>        mNavigationArea.setLayoutTransition(lt);</p>
<p>        // no multi-touch on the nav buttons</p>
<p>        mNavigationArea.setMotionEventSplittingEnabled(false);</p>
<p>        // The bar contents buttons</p>
<p>        mFeedbackIconArea = (ViewGroup)sb.findViewById(R.id.feedbackIconArea);</p>
<p>        mInputMethodSwitchButton = (InputMethodButton) sb.findViewById(R.id.imeSwitchButton);</p>
<p>        // Overwrite the lister</p>
<p>        mInputMethodSwitchButton.setOnClickListener(mOnClickListener);</p>
<p>        mCompatModeButton = (CompatModeButton) sb.findViewById(R.id.compatModeButton);</p>
<p>        mCompatModeButton.setOnClickListener(mOnClickListener);</p>
<p>        mCompatModeButton.setVisibility(View.GONE);</p>
<p>        mScreenshot=(ImageView)sb.findViewById(R.id.screenshot);</p>
<p>        mScreenshot.setOnClickListener(new View.OnClickListener() {</p>
<p>                        @Override</p>
<p>                        public void onClick(View v) {</p>
<p>                                // TODO Auto-generated method stub</p>
<p>                                takeScreenshot();</p>
<p>                                //Intent intent=new Intent();</p>
<p>                                //intent.setAction(&quot;rk.android.screenshot.ACTION&quot;);</p>
<p>                                //mContext.sendBroadcast(intent);</p>
<p>                        }</p>
<p>                });</p>
<p>        boolean show=Settings.System.getInt(mContext.getContentResolver(),</p>
<p>                        Settings.System.SCREENSHOT_BUTTON_SHOW, 0)==1;</p>
<p>        if(show){</p>
<p>                mScreenshot.setVisibility(View.VISIBLE);</p>
<p>        }else{</p>
<p>                mScreenshot.setVisibility(View.GONE);</p>
<p>        }</p>
<p>        // for redirecting errant bar taps to the IME</p>
<p>        mFakeSpaceBar = sb.findViewById(R.id.fake_space_bar);</p>
<p>        // &quot;shadows&quot; of the status bar features, for lights-out mode</p>
<p>        mShadow = sb.findViewById(R.id.bar_shadow);</p>
<p>        mShadow.setOnTouchListener(</p>
<p>            new View.OnTouchListener() {</p>
<p>                public boolean onTouch(View v, MotionEvent ev) {</p>
<p>                    if (ev.getAction() == MotionEvent.ACTION_DOWN) {</p>
<p>                        // even though setting the systemUI visibility below will turn these views</p>
<p>                        // on, we need them to come up faster so that they can catch this motion</p>
<p>                        // event</p>
<p>                        mShadow.setVisibility(View.GONE);</p>
<p>                        mBarContents.setVisibility(View.VISIBLE);</p>
<p>                        try {</p>
<p>                            mBarService.setSystemUiVisibility(0, View.SYSTEM_UI_FLAG_LOW_PROFILE);</p>
<p>                        } catch (RemoteException ex) {</p>
<p>                            // system process dead</p>
<p>                        }</p>
<p>                    }</p>
<p>                    return false;</p>
<p>                }</p>
<p>            });</p>
<p>        // tuning parameters</p>
<p>        final int LIGHTS_GOING_OUT_SYSBAR_DURATION = 750;</p>
<p>        final int LIGHTS_GOING_OUT_SHADOW_DURATION = 750;</p>
<p>        final int LIGHTS_GOING_OUT_SHADOW_DELAY    = 0;</p>
<p>        final int LIGHTS_COMING_UP_SYSBAR_DURATION = 200;</p>
<p>//        final int LIGHTS_COMING_UP_SYSBAR_DELAY    = 50;</p>
<p>        final int LIGHTS_COMING_UP_SHADOW_DURATION = 0;</p>
<p>        LayoutTransition xition = new LayoutTransition();</p>
<p>        xition.setAnimator(LayoutTransition.APPEARING,</p>
<p>               ObjectAnimator.ofFloat(null, &quot;alpha&quot;, 0.5f, 1f));</p>
<p>        xition.setDuration(LayoutTransition.APPEARING, LIGHTS_COMING_UP_SYSBAR_DURATION);</p>
<p>        xition.setStartDelay(LayoutTransition.APPEARING, 0);</p>
<p>        xition.setAnimator(LayoutTransition.DISAPPEARING,</p>
<p>               ObjectAnimator.ofFloat(null, &quot;alpha&quot;, 1f, 0f));</p>
<p>        xition.setDuration(LayoutTransition.DISAPPEARING, LIGHTS_GOING_OUT_SYSBAR_DURATION);</p>
<p>        xition.setStartDelay(LayoutTransition.DISAPPEARING, 0);</p>
<p>        ((ViewGroup)sb.findViewById(R.id.bar_contents_holder)).setLayoutTransition(xition);</p>
<p>        xition = new LayoutTransition();</p>
<p>        xition.setAnimator(LayoutTransition.APPEARING,</p>
<p>               ObjectAnimator.ofFloat(null, &quot;alpha&quot;, 0f, 1f));</p>
<p>        xition.setDuration(LayoutTransition.APPEARING, LIGHTS_GOING_OUT_SHADOW_DURATION);</p>
<p>        xition.setStartDelay(LayoutTransition.APPEARING, LIGHTS_GOING_OUT_SHADOW_DELAY);</p>
<p>        xition.setAnimator(LayoutTransition.DISAPPEARING,</p>
<p>               ObjectAnimator.ofFloat(null, &quot;alpha&quot;, 1f, 0f));</p>
<p>        xition.setDuration(LayoutTransition.DISAPPEARING, LIGHTS_COMING_UP_SHADOW_DURATION);</p>
<p>        xition.setStartDelay(LayoutTransition.DISAPPEARING, 0);</p>
<p>        ((ViewGroup)sb.findViewById(R.id.bar_shadow_holder)).setLayoutTransition(xition);</p>
<p>        // set the initial view visibility</p>
<p>        setAreThereNotifications();</p>
<p>        // receive broadcasts</p>
<p>        IntentFilter filter = new IntentFilter();</p>
<p>        filter.addAction(Intent.ACTION_CLOSE_SYSTEM_DIALOGS);</p>
<p>        filter.addAction(Intent.ACTION_SCREEN_OFF);</p>
<p>        context.registerReceiver(mBroadcastReceiver, filter);</p>
<p>        return sb;</p>
<p>    }</p>
<p>    @Override</p>
<p>    protected WindowManager.LayoutParams getRecentsLayoutParams(LayoutParams layoutParams) {</p>
<p>        WindowManager.LayoutParams lp = new WindowManager.LayoutParams(</p>
<p>                (int) mContext.getResources().getDimension(R.dimen.status_bar_recents_width),</p>
<p>                ViewGroup.LayoutParams.MATCH_PARENT,</p>
<p>                WindowManager.LayoutParams.TYPE_NAVIGATION_BAR_PANEL,</p>
<p>                WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN</p>
<p>                | WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM</p>
<p>                | WindowManager.LayoutParams.FLAG_SPLIT_TOUCH</p>
<p>                | WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED,</p>
<p>                PixelFormat.TRANSLUCENT);</p>
<p>        lp.gravity = Gravity.BOTTOM | Gravity.LEFT;</p>
<p>        lp.setTitle(&quot;RecentsPanel&quot;);</p>
<p>        lp.windowAnimations = com.android.internal.R.style.Animation_RecentApplications;</p>
<p>        lp.softInputMode = WindowManager.LayoutParams.SOFT_INPUT_STATE_UNCHANGED</p>
<p>            | WindowManager.LayoutParams.SOFT_INPUT_ADJUST_NOTHING;</p>
<p>        return lp;</p>
<p>    }</p>
<p>    @Override</p>
<p>    protected WindowManager.LayoutParams getSearchLayoutParams(LayoutParams layoutParams) {</p>
<p>        boolean opaque = false;</p>
<p>        WindowManager.LayoutParams lp = new WindowManager.LayoutParams(</p>
<p>                LayoutParams.MATCH_PARENT,</p>
<p>                LayoutParams.MATCH_PARENT,</p>
<p>                WindowManager.LayoutParams.TYPE_NAVIGATION_BAR_PANEL,</p>
<p>                WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN</p>
<p>                        | WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM</p>
<p>                        | WindowManager.LayoutParams.FLAG_SPLIT_TOUCH,</p>
<p>                (opaque ? PixelFormat.OPAQUE : PixelFormat.TRANSLUCENT));</p>
<p>        if (ActivityManager.isHighEndGfx(mDisplay)) {</p>
<p>            lp.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;</p>
<p>        } else {</p>
<p>            lp.flags |= WindowManager.LayoutParams.FLAG_DIM_BEHIND;</p>
<p>            lp.dimAmount = 0.7f;</p>
<p>        }</p>
<p>        lp.gravity = Gravity.BOTTOM | Gravity.LEFT;</p>
<p>        lp.setTitle(&quot;SearchPanel&quot;);</p>
<p>        // TODO: Define custom animation for Search panel</p>
<p>        lp.windowAnimations = com.android.internal.R.style.Animation_RecentApplications;</p>
<p>        lp.softInputMode = WindowManager.LayoutParams.SOFT_INPUT_STATE_UNCHANGED</p>
<p>                | WindowManager.LayoutParams.SOFT_INPUT_ADJUST_NOTHING;</p>
<p>        return lp;</p>
<p>    }</p>
<p>    protected void updateRecentsPanel() {</p>
<p>        super.updateRecentsPanel(R.layout.system_bar_recent_panel);</p>
<p>        mRecentsPanel.setStatusBarView(mStatusBarView);</p>
<p>    }</p>
<p>    @Override</p>
<p>    protected void updateSearchPanel() {</p>
<p>        super.updateSearchPanel();</p>
<p>        mSearchPanelView.setStatusBarView(mStatusBarView);</p>
<p>        mStatusBarView.setDelegateView(mSearchPanelView);</p>
<p>    }</p>
<p>    @Override</p>
<p>    public void showSearchPanel() {</p>
<p>        super.showSearchPanel();</p>
<p>        WindowManager.LayoutParams lp =</p>
<p>            (android.view.WindowManager.LayoutParams) mStatusBarView.getLayoutParams();</p>
<p>        lp.flags &amp;= ~WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;</p>
<p>        WindowManagerImpl.getDefault().updateViewLayout(mStatusBarView, lp);</p>
<p>    }</p>
<p>    @Override</p>
<p>    public void hideSearchPanel() {</p>
<p>        super.hideSearchPanel();</p>
<p>        WindowManager.LayoutParams lp =</p>
<p>            (android.view.WindowManager.LayoutParams) mStatusBarView.getLayoutParams();</p>
<p>        lp.flags |= WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL;</p>
<p>        WindowManagerImpl.getDefault().updateViewLayout(mStatusBarView, lp);</p>
<p>    }</p>
<p>    public int getStatusBarHeight() {</p>
<p>        return mStatusBarView != null ? mStatusBarView.getHeight()</p>
<p>                : mContext.getResources().getDimensionPixelSize(</p>
<p>                        com.android.internal.R.dimen.navigation_bar_height);</p>
<p>    }</p>
<p>    protected int getStatusBarGravity() {</p>
<p>        return Gravity.BOTTOM | Gravity.FILL_HORIZONTAL;</p>
<p>    }</p>
<p>    public void onBarHeightChanged(int height) {</p>
<p>        final WindowManager.LayoutParams lp</p>
<p>                = (WindowManager.LayoutParams)mStatusBarView.getLayoutParams();</p>
<p>        if (lp == null) {</p>
<p>            // haven’t been added yet</p>
<p>            return;</p>
<p>        }</p>
<p>        if (lp.height != height) {</p>
<p>            lp.height = height;</p>
<p>            final WindowManager wm = WindowManagerImpl.getDefault();</p>
<p>            wm.updateViewLayout(mStatusBarView, lp);</p>
<p>        }</p>
<p>    }</p>
<p>    @Override</p>
<p>    protected BaseStatusBar.H createHandler() {</p>
<p>        return new TabletStatusBar.H();</p>
<p>    }</p>
<p>    private class H extends BaseStatusBar.H {</p>
<p>        public void handleMessage(Message m) {</p>
<p>            super.handleMessage(m);</p>
<p>            switch (m.what) {</p>
<p>                case MSG_OPEN_NOTIFICATION_PEEK:</p>
<p>                    if (DEBUG) Slog.d(TAG, &quot;opening notification peek window; arg=&quot; + m.arg1);</p>
<p>                    if (m.arg1 &gt;= 0) {</p>
<p>                        final int N = mNotificationData.size();</p>
<p>                        if (!mNotificationDNDMode) {</p>
<p>                            if (mNotificationPeekIndex &gt;= 0 &amp;&amp; mNotificationPeekIndex &lt; N) {</p>
<p>                                NotificationData.Entry entry = mNotificationData.get(N-1-mNotificationPeekIndex);</p>
<p>                                entry.icon.setBackgroundColor(0);</p>
<p>                                mNotificationPeekIndex = -1;</p>
<p>                                mNotificationPeekKey = null;</p>
<p>                            }</p>
<p>                        }</p>
<p>                        final int peekIndex = m.arg1;</p>
<p>                        if (peekIndex &lt; N) {</p>
<p>                            //Slog.d(TAG, &quot;loading peek: &quot; + peekIndex);</p>
<p>                            NotificationData.Entry entry =</p>
<p>                                mNotificationDNDMode</p>
<p>                                    ? mNotificationDNDDummyEntry</p>
<p>                                    : mNotificationData.get(N-1-peekIndex);</p>
<p>                            NotificationData.Entry copy = new NotificationData.Entry(</p>
<p>                                    entry.key,</p>
<p>                                    entry.notification,</p>
<p>                                    entry.icon);</p>
<p>                            inflateViews(copy, mNotificationPeekRow);</p>
<p>                            if (mNotificationDNDMode) {</p>
<p>                                copy.content.setOnClickListener(new View.OnClickListener() {</p>
<p>                                    public void onClick(View v) {</p>
<p>                                        SharedPreferences.Editor editor = Prefs.edit(mContext);</p>
<p>                                        editor.putBoolean(Prefs.DO_NOT_DISTURB_PREF, false);</p>
<p>                                        editor.apply();</p>
<p>                                        animateCollapse();</p>
<p>                                        visibilityChanged(false);</p>
<p>                                    }</p>
<p>                                });</p>
<p>                            }</p>
<p>                            entry.icon.setBackgroundColor(0x20FFFFFF);</p>
<p>//                          mNotificationPeekRow.setLayoutTransition(</p>
<p>//                              peekIndex &lt; mNotificationPeekIndex</p>
<p>//                                  ? mNotificationPeekScrubLeft</p>
<p>//                                  : mNotificationPeekScrubRight);</p>
<p>                            mNotificationPeekRow.removeAllViews();</p>
<p>                            mNotificationPeekRow.addView(copy.row);</p>
<p>                            mNotificationPeekWindow.setVisibility(View.VISIBLE);</p>
<p>                            mNotificationPanel.show(false, true);</p>
<p>                            mNotificationPeekIndex = peekIndex;</p>
<p>                            mNotificationPeekKey = entry.key;</p>
<p>                        }</p>
<p>                    }</p>
<p>                    break;</p>
<p>                case MSG_CLOSE_NOTIFICATION_PEEK:</p>
<p>                    if (DEBUG) Slog.d(TAG, &quot;closing notification peek window&quot;);</p>
<p>                    mNotificationPeekWindow.setVisibility(View.GONE);</p>
<p>                    mNotificationPeekRow.removeAllViews();</p>
<p>                    final int N = mNotificationData.size();</p>
<p>                    if (mNotificationPeekIndex &gt;= 0 &amp;&amp; mNotificationPeekIndex &lt; N) {</p>
<p>                        NotificationData.Entry entry =</p>
<p>                            mNotificationDNDMode</p>
<p>                                ? mNotificationDNDDummyEntry</p>
<p>                                : mNotificationData.get(N-1-mNotificationPeekIndex);</p>
<p>                        entry.icon.setBackgroundColor(0);</p>
<p>                    }</p>
<p>                    mNotificationPeekIndex = -1;</p>
<p>                    mNotificationPeekKey = null;</p>
<p>                    break;</p>
<p>                case MSG_OPEN_NOTIFICATION_PANEL:</p>
<p>                    if (DEBUG) Slog.d(TAG, &quot;opening notifications panel&quot;);</p>
<p>                    if (!mNotificationPanel.isShowing()) {</p>
<p>                        mNotificationPanel.show(true, true);</p>
<p>                        mNotificationArea.setVisibility(View.INVISIBLE);</p>
<p>                        mTicker.halt();</p>
<p>                    }</p>
<p>                    break;</p>
<p>                case MSG_CLOSE_NOTIFICATION_PANEL:</p>
<p>                    if (DEBUG) Slog.d(TAG, &quot;closing notifications panel&quot;);</p>
<p>                    if (mNotificationPanel.isShowing()) {</p>
<p>                        mNotificationPanel.show(false, true);</p>
<p>                        mNotificationArea.setVisibility(View.VISIBLE);</p>
<p>                    }</p>
<p>                    break;</p>
<p>                case MSG_OPEN_INPUT_METHODS_PANEL:</p>
<p>                    if (DEBUG) Slog.d(TAG, &quot;opening input methods panel&quot;);</p>
<p>                    if (mInputMethodsPanel != null) mInputMethodsPanel.openPanel();</p>
<p>                    break;</p>
<p>                case MSG_CLOSE_INPUT_METHODS_PANEL:</p>
<p>                    if (DEBUG) Slog.d(TAG, &quot;closing input methods panel&quot;);</p>
<p>                    if (mInputMethodsPanel != null) mInputMethodsPanel.closePanel(false);</p>
<p>                    break;</p>
<p>                case MSG_OPEN_COMPAT_MODE_PANEL:</p>
<p>                    if (DEBUG) Slog.d(TAG, &quot;opening compat panel&quot;);</p>
<p>                    if (mCompatModePanel != null) mCompatModePanel.openPanel();</p>
<p>                    break;</p>
<p>                case MSG_CLOSE_COMPAT_MODE_PANEL:</p>
<p>                    if (DEBUG) Slog.d(TAG, &quot;closing compat panel&quot;);</p>
<p>                    if (mCompatModePanel != null) mCompatModePanel.closePanel();</p>
<p>                    break;</p>
<p>                case MSG_SHOW_CHROME:</p>
<p>                    if (DEBUG) Slog.d(TAG, &quot;hiding shadows (lights on)&quot;);</p>
<p>                    mBarContents.setVisibility(View.VISIBLE);</p>
<p>                    mShadow.setVisibility(View.GONE);</p>
<p>                    mSystemUiVisibility &amp;= ~View.SYSTEM_UI_FLAG_LOW_PROFILE;</p>
<p>                    mStatusBarView.setVisibility(View.VISIBLE);</p>
<p>                    notifyUiVisibilityChanged();</p>
<p>                    break;</p>
<p>                case MSG_HIDE_CHROME:</p>
<p>                    if (DEBUG) Slog.d(TAG, &quot;showing shadows (lights out)&quot;);</p>
<p>                    animateCollapse();</p>
<p>                    visibilityChanged(false);</p>
<p>                    mBarContents.setVisibility(View.GONE);</p>
<p>                    mShadow.setVisibility(View.VISIBLE);</p>
<p>                    mSystemUiVisibility |= View.SYSTEM_UI_FLAG_LOW_PROFILE;</p>
<p>                    if(HIDE_TABLET_STATUSBAR){</p>
<p>                        mStatusBarView.setVisibility(View.GONE);</p>
<p>                    }else{</p>
<p>                        mStatusBarView.setVisibility(View.VISIBLE);</p>
<p>                    }</p>
<p>                    notifyUiVisibilityChanged();</p>
<p>                    break;</p>
<p>                case MSG_STOP_TICKER:</p>
<p>                    mTicker.halt();</p>
<p>                    break;</p>
<p>            }</p>
<p>        }</p>
<p>    }</p>
<p>    public void addIcon(String slot, int index, int viewIndex, StatusBarIcon icon) {</p>
<p>        if (DEBUG) Slog.d(TAG, &quot;addIcon(&quot; + slot + &quot;) -&gt; &quot; + icon);</p>
<p>    }</p>
<p>    public void updateIcon(String slot, int index, int viewIndex,</p>
<p>            StatusBarIcon old, StatusBarIcon icon) {</p>
<p>        if (DEBUG) Slog.d(TAG, &quot;updateIcon(&quot; + slot + &quot;) -&gt; &quot; + icon);</p>
<p>    }</p>
<p>    public void removeIcon(String slot, int index, int viewIndex) {</p>
<p>        if (DEBUG) Slog.d(TAG, &quot;removeIcon(&quot; + slot + &quot;)&quot;);</p>
<p>    }</p>
<p>    public void addNotification(IBinder key, StatusBarNotification notification) {</p>
<p>        if (DEBUG) Slog.d(TAG, &quot;addNotification(&quot; + key + &quot; -&gt; &quot; + notification + &quot;)&quot;);</p>
<p>        addNotificationViews(key, notification);</p>
<p>        final boolean immersive = isImmersive();</p>
<p>        if (false &amp;&amp; immersive) {</p>
<p>            // TODO: immersive mode popups for tablet</p>
<p>        } else if (notification.notification.fullScreenIntent != null) {</p>
<p>            // not immersive &amp; a full-screen alert should be shown</p>
<p>            Slog.w(TAG, &quot;Notification has fullScreenIntent and activity is not immersive;&quot;</p>
<p>                    + &quot; sending fullScreenIntent&quot;);</p>
<p>            try {</p>
<p>                notification.notification.fullScreenIntent.send();</p>
<p>            } catch (PendingIntent.CanceledException e) {</p>
<p>            }</p>
<p>        } else {</p>
<p>            tick(key, notification, true);</p>
<p>        }</p>
<p>        setAreThereNotifications();</p>
<p>    }</p>
<p>    public void removeNotification(IBinder key) {</p>
<p>        if (DEBUG) Slog.d(TAG, &quot;removeNotification(&quot; + key + &quot;)&quot;);</p>
<p>        removeNotificationViews(key);</p>
<p>        mTicker.remove(key);</p>
<p>        setAreThereNotifications();</p>
<p>    }</p>
<p>    public void showClock(boolean show) {</p>
<p>        View clock = mBarContents.findViewById(R.id.clock);</p>
<p>        View network_text = mBarContents.findViewById(R.id.network_text);</p>
<p>        if (clock != null) {</p>
<p>            clock.setVisibility(show ? View.VISIBLE : View.GONE);</p>
<p>        }</p>
<p>        if (network_text != null) {</p>
<p>            network_text.setVisibility((!show) ? View.VISIBLE : View.GONE);</p>
<p>        }</p>
<p>    }</p>
<p>    public void disable(int state) {</p>
<p>        int old = mDisabled;</p>
<p>        int diff = state ^ old;</p>
<p>        mDisabled = state;</p>
<p>        // act accordingly</p>
<p>        if ((diff &amp; StatusBarManager.DISABLE_CLOCK) != 0) {</p>
<p>            boolean show = (state &amp; StatusBarManager.DISABLE_CLOCK) == 0;</p>
<p>            Slog.i(TAG, &quot;DISABLE_CLOCK: &quot; + (show ? &quot;no&quot; : &quot;yes&quot;));</p>
<p>            showClock(show);</p>
<p>        }</p>
<p>        if ((diff &amp; StatusBarManager.DISABLE_SYSTEM_INFO) != 0) {</p>
<p>            boolean show = (state &amp; StatusBarManager.DISABLE_SYSTEM_INFO) == 0;</p>
<p>            Slog.i(TAG, &quot;DISABLE_SYSTEM_INFO: &quot; + (show ? &quot;no&quot; : &quot;yes&quot;));</p>
<p>            mNotificationTrigger.setVisibility(show ? View.VISIBLE : View.GONE);</p>
<p>        }</p>
<p>        if ((diff &amp; StatusBarManager.DISABLE_EXPAND) != 0) {</p>
<p>            if ((state &amp; StatusBarManager.DISABLE_EXPAND) != 0) {</p>
<p>                Slog.i(TAG, &quot;DISABLE_EXPAND: yes&quot;);</p>
<p>                animateCollapse();</p>
<p>                visibilityChanged(false);</p>
<p>            }</p>
<p>        }</p>
<p>        if ((diff &amp; StatusBarManager.DISABLE_NOTIFICATION_ICONS) != 0) {</p>
<p>            mNotificationDNDMode = Prefs.read(mContext)</p>
<p>                        .getBoolean(Prefs.DO_NOT_DISTURB_PREF, Prefs.DO_NOT_DISTURB_DEFAULT);</p>
<p>            if ((state &amp; StatusBarManager.DISABLE_NOTIFICATION_ICONS) != 0) {</p>
<p>                Slog.i(TAG, &quot;DISABLE_NOTIFICATION_ICONS: yes&quot; + (mNotificationDNDMode?&quot; (DND)&quot;:&quot;&quot;));</p>
<p>                mTicker.halt();</p>
<p>            } else {</p>
<p>                Slog.i(TAG, &quot;DISABLE_NOTIFICATION_ICONS: no&quot; + (mNotificationDNDMode?&quot; (DND)&quot;:&quot;&quot;));</p>
<p>            }</p>
<p>            // refresh icons to show either notifications or the DND message</p>
<p>            reloadAllNotificationIcons();</p>
<p>        } else if ((diff &amp; StatusBarManager.DISABLE_NOTIFICATION_TICKER) != 0) {</p>
<p>            if ((state &amp; StatusBarManager.DISABLE_NOTIFICATION_TICKER) != 0) {</p>
<p>                mTicker.halt();</p>
<p>            }</p>
<p>        }</p>
<p>        if ((diff &amp; (StatusBarManager.DISABLE_RECENT</p>
<p>                        | StatusBarManager.DISABLE_BACK</p>
<p>                        | StatusBarManager.DISABLE_HOME)) != 0) {</p>
<p>            setNavigationVisibility(state);</p>
<p>            if ((state &amp; StatusBarManager.DISABLE_RECENT) != 0) {</p>
<p>                // close recents if it’s visible</p>
<p>                mHandler.removeMessages(MSG_CLOSE_RECENTS_PANEL);</p>
<p>                mHandler.sendEmptyMessage(MSG_CLOSE_RECENTS_PANEL);</p>
<p>            }</p>
<p>        }</p>
<p>    }</p>
<p>    private void setNavigationVisibility(int visibility) {</p>
<p>        boolean disableHome = ((visibility &amp; StatusBarManager.DISABLE_HOME) != 0);</p>
<p>        boolean disableRecent = ((visibility &amp; StatusBarManager.DISABLE_RECENT) != 0);</p>
<p>        boolean disableBack = ((visibility &amp; StatusBarManager.DISABLE_BACK) != 0);</p>
<p>        mBackButton.setVisibility(disableBack ? View.INVISIBLE : View.VISIBLE);</p>
<p>        mHomeButton.setVisibility(disableHome ? View.INVISIBLE : View.VISIBLE);</p>
<p>        mRecentButton.setVisibility(disableRecent ? View.INVISIBLE : View.VISIBLE);</p>
<p>if((&quot;true&quot;.equals(isEnableShowVoiceIcon)) &amp;&amp; (mContext.getResources().getConfiguration().orientation == Configuration.ORIENTATION_LANDSCAPE)){</p>
<p>mVolumeUpButton.setVisibility(disableRecent ? View.INVISIBLE : View.VISIBLE);</p>
<p>mVolumeDownButton.setVisibility(disableRecent ? View.INVISIBLE : View.VISIBLE);</p>
<p>}</p>
<p>if(Settings.System.getInt(mContext.getContentResolver(),</p>
<p>                        Settings.System.SCREENSHOT_BUTTON_SHOW, 0)==1){</p>
<p>             mScreenshot.setVisibility(disableRecent ? View.INVISIBLE : View.VISIBLE);</p>
<p>}</p>
<p>        mInputMethodSwitchButton.setScreenLocked(</p>
<p>                (visibility &amp; StatusBarManager.DISABLE_SYSTEM_INFO) != 0);</p>
<p>    }</p>
<p>    private boolean hasTicker(Notification n) {</p>
<p>        return n.tickerView != null || !TextUtils.isEmpty(n.tickerText);</p>
<p>    }</p>
<p>    @Override</p>
<p>    protected void tick(IBinder key, StatusBarNotification n, boolean firstTime) {</p>
<p>        // Don’t show the ticker when the windowshade is open.</p>
<p>        if (mNotificationPanel.isShowing()) {</p>
<p>            return;</p>
<p>        }</p>
<p>        // If they asked for FLAG_ONLY_ALERT_ONCE, then only show this notification</p>
<p>        // if it’s a new notification.</p>
<p>        if (!firstTime &amp;&amp; (n.notification.flags &amp; Notification.FLAG_ONLY_ALERT_ONCE) != 0) {</p>
<p>            return;</p>
<p>        }</p>
<p>        // Show the ticker if one is requested. Also don’t do this</p>
<p>        // until status bar window is attached to the window manager,</p>
<p>        // because…  well, what’s the point otherwise?  And trying to</p>
<p>        // run a ticker without being attached will crash!</p>
<p>        if (hasTicker(n.notification) &amp;&amp; mStatusBarView.getWindowToken() != null) {</p>
<p>            if (0 == (mDisabled &amp; (StatusBarManager.DISABLE_NOTIFICATION_ICONS</p>
<p>                            | StatusBarManager.DISABLE_NOTIFICATION_TICKER))) {</p>
<p>                mTicker.add(key, n);</p>
<p>                mFeedbackIconArea.setVisibility(View.GONE);</p>
<p>            }</p>
<p>        }</p>
<p>    }</p>
<p>    // called by TabletTicker when it’s done with all queued ticks</p>
<p>    public void doneTicking() {</p>
<p>        mFeedbackIconArea.setVisibility(View.VISIBLE);</p>
<p>    }</p>
<p>    public void animateExpand() {</p>
<p>        mHandler.removeMessages(MSG_OPEN_NOTIFICATION_PANEL);</p>
<p>        mHandler.sendEmptyMessage(MSG_OPEN_NOTIFICATION_PANEL);</p>
<p>    }</p>
<p>    public void animateCollapse() {</p>
<p>        animateCollapse(CommandQueue.FLAG_EXCLUDE_NONE);</p>
<p>    }</p>
<p>    public void animateCollapse(int flags) {</p>
<p>        if ((flags &amp; CommandQueue.FLAG_EXCLUDE_NOTIFICATION_PANEL) == 0) {</p>
<p>            mHandler.removeMessages(MSG_CLOSE_NOTIFICATION_PANEL);</p>
<p>            mHandler.sendEmptyMessage(MSG_CLOSE_NOTIFICATION_PANEL);</p>
<p>        }</p>
<p>        if ((flags &amp; CommandQueue.FLAG_EXCLUDE_RECENTS_PANEL) == 0) {</p>
<p>            mHandler.removeMessages(MSG_CLOSE_RECENTS_PANEL);</p>
<p>            mHandler.sendEmptyMessage(MSG_CLOSE_RECENTS_PANEL);</p>
<p>        }</p>
<p>        if ((flags &amp; CommandQueue.FLAG_EXCLUDE_SEARCH_PANEL) == 0) {</p>
<p>            mHandler.removeMessages(MSG_CLOSE_SEARCH_PANEL);</p>
<p>            mHandler.sendEmptyMessage(MSG_CLOSE_SEARCH_PANEL);</p>
<p>        }</p>
<p>        if ((flags &amp; CommandQueue.FLAG_EXCLUDE_INPUT_METHODS_PANEL) == 0) {</p>
<p>            mHandler.removeMessages(MSG_CLOSE_INPUT_METHODS_PANEL);</p>
<p>            mHandler.sendEmptyMessage(MSG_CLOSE_INPUT_METHODS_PANEL);</p>
<p>        }</p>
<p>        if ((flags &amp; CommandQueue.FLAG_EXCLUDE_COMPAT_MODE_PANEL) == 0) {</p>
<p>            mHandler.removeMessages(MSG_CLOSE_COMPAT_MODE_PANEL);</p>
<p>            mHandler.sendEmptyMessage(MSG_CLOSE_COMPAT_MODE_PANEL);</p>
<p>        }</p>
<p>    }</p>
<p>    @Override // CommandQueue</p>
<p>    public void setNavigationIconHints(int hints) {</p>
<p>        if (hints == mNavigationIconHints) return;</p>
<p>        if (DEBUG) {</p>
<p>            android.widget.Toast.makeText(mContext,</p>
<p>                &quot;Navigation icon hints = &quot; + hints,</p>
<p>                500).show();</p>
<p>        }</p>
<p>        mNavigationIconHints = hints;</p>
<p>        mBackButton.setAlpha(</p>
<p>            (0 != (hints &amp; StatusBarManager.NAVIGATION_HINT_BACK_NOP)) ? 0.5f : 1.0f);</p>
<p>        mHomeButton.setAlpha(</p>
<p>            (0 != (hints &amp; StatusBarManager.NAVIGATION_HINT_HOME_NOP)) ? 0.5f : 1.0f);</p>
<p>        mRecentButton.setAlpha(</p>
<p>            (0 != (hints &amp; StatusBarManager.NAVIGATION_HINT_RECENT_NOP)) ? 0.5f : 1.0f);</p>
<p>        mBackButton.setImageResource(</p>
<p>            (0 != (hints &amp; StatusBarManager.NAVIGATION_HINT_BACK_ALT))</p>
<p>                ? R.drawable.ic_sysbar_back_ime</p>
<p>                : R.drawable.ic_sysbar_back);</p>
<p>    }</p>
<p>    private void notifyUiVisibilityChanged() {</p>
<p>        try {</p>
<p>            mWindowManager.statusBarVisibilityChanged(mSystemUiVisibility);</p>
<p>        } catch (RemoteException ex) {</p>
<p>        }</p>
<p>    }</p>
<p>    @Override // CommandQueue</p>
<p>    public void setSystemUiVisibility(int vis, int mask) {</p>
<p>       // final int oldVal = mSystemUiVisibility;</p>
<p>       // final int newVal = (oldVal&amp;~mask) | (vis&amp;mask);</p>
<p>      //  final int diff = newVal ^ oldVal;</p>
<p>          if (vis != mSystemUiVisibility) {</p>
<p>            mSystemUiVisibility = vis;</p>
<p>           // if (0 != (diff &amp; View.SYSTEM_UI_FLAG_LOW_PROFILE)) {</p>
<p>                mHandler.removeMessages(MSG_HIDE_CHROME);</p>
<p>                mHandler.removeMessages(MSG_SHOW_CHROME);</p>
<p>                int fs = vis &amp; View.SYSTEM_UI_FLAG_SHOW_FULLSCREEN;</p>
<p>                int lp =  vis &amp; View.SYSTEM_UI_FLAG_LOW_PROFILE;</p>
<p>                if(fs != 0){</p>
<p>                     HIDE_TABLET_STATUSBAR = true;</p>
<p>                }else{</p>
<p>                     HIDE_TABLET_STATUSBAR = false;</p>
<p>                }</p>
<p>                mHandler.sendEmptyMessage((lp!=0||fs != 0) ? MSG_HIDE_CHROME : MSG_SHOW_CHROME);</p>
<p>          //  }</p>
<p>            notifyUiVisibilityChanged();</p>
<p>        }</p>
<p>    }</p>
<p>    public void setLightsOn(boolean on) {</p>
<p>        // Policy note: if the frontmost activity needs the menu key, we assume it is a legacy app</p>
<p>        // that can’t handle lights-out mode.</p>
<p>        if (mMenuButton.getVisibility() == View.VISIBLE) {</p>
<p>            on = true;</p>
<p>        }</p>
<p>        Slog.v(TAG, &quot;setLightsOn(&quot; + on + &quot;)&quot;);</p>
<p>        if (on) {</p>
<p>            setSystemUiVisibility(0, View.SYSTEM_UI_FLAG_LOW_PROFILE);</p>
<p>        } else {</p>
<p>            setSystemUiVisibility(View.SYSTEM_UI_FLAG_LOW_PROFILE, View.SYSTEM_UI_FLAG_LOW_PROFILE);</p>
<p>        }</p>
<p>    }</p>
<p>    public void topAppWindowChanged(boolean showMenu) {</p>
<p>        if (DEBUG) {</p>
<p>            Slog.d(TAG, (showMenu?&quot;showing&quot;:&quot;hiding&quot;) + &quot; the MENU button&quot;);</p>
<p>        }</p>
<p>        mMenuButton.setVisibility(showMenu ? View.VISIBLE : View.GONE);</p>
<p>        // See above re: lights-out policy for legacy apps.</p>
<p>        if (showMenu) setLightsOn(true);</p>
<p>        mCompatModeButton.refresh();</p>
<p>        if (mCompatModeButton.getVisibility() == View.VISIBLE) {</p>
<p>            if (DEBUG_COMPAT_HELP</p>
<p>                    || ! Prefs.read(mContext).getBoolean(Prefs.SHOWN_COMPAT_MODE_HELP, false)) {</p>
<p>                showCompatibilityHelp();</p>
<p>            }</p>
<p>        } else {</p>
<p>            hideCompatibilityHelp();</p>
<p>            mCompatModePanel.closePanel();</p>
<p>        }</p>
<p>    }</p>
<p>    private void showCompatibilityHelp() {</p>
<p>        if (mCompatibilityHelpDialog != null) {</p>
<p>            return;</p>
<p>        }</p>
<p>        mCompatibilityHelpDialog = View.inflate(mContext, R.layout.compat_mode_help, null);</p>
<p>        View button = mCompatibilityHelpDialog.findViewById(R.id.button);</p>
<p>        button.setOnClickListener(new View.OnClickListener() {</p>
<p>            @Override</p>
<p>            public void onClick(View v) {</p>
<p>                hideCompatibilityHelp();</p>
<p>                SharedPreferences.Editor editor = Prefs.edit(mContext);</p>
<p>                editor.putBoolean(Prefs.SHOWN_COMPAT_MODE_HELP, true);</p>
<p>                editor.apply();</p>
<p>            }</p>
<p>        });</p>
<p>        WindowManager.LayoutParams lp = new WindowManager.LayoutParams(</p>
<p>                ViewGroup.LayoutParams.MATCH_PARENT,</p>
<p>                ViewGroup.LayoutParams.MATCH_PARENT,</p>
<p>                WindowManager.LayoutParams.TYPE_SYSTEM_DIALOG,</p>
<p>                WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN</p>
<p>                    | WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS</p>
<p>                    | WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM,</p>
<p>                PixelFormat.TRANSLUCENT);</p>
<p>        lp.setTitle(&quot;CompatibilityModeDialog&quot;);</p>
<p>        lp.softInputMode = WindowManager.LayoutParams.SOFT_INPUT_STATE_UNCHANGED</p>
<p>                | WindowManager.LayoutParams.SOFT_INPUT_ADJUST_NOTHING;</p>
<p>        lp.windowAnimations = com.android.internal.R.style.Animation_ZoomButtons; // simple fade</p>
<p>        WindowManagerImpl.getDefault().addView(mCompatibilityHelpDialog, lp);</p>
<p>    }</p>
<p>    private void hideCompatibilityHelp() {</p>
<p>        if (mCompatibilityHelpDialog != null) {</p>
<p>            WindowManagerImpl.getDefault().removeView(mCompatibilityHelpDialog);</p>
<p>            mCompatibilityHelpDialog = null;</p>
<p>        }</p>
<p>    }</p>
<p>    public void setImeWindowStatus(IBinder token, int vis, int backDisposition) {</p>
<p>        mInputMethodSwitchButton.setImeWindowStatus(token,</p>
<p>                (vis &amp; InputMethodService.IME_ACTIVE) != 0);</p>
<p>        updateNotificationIcons();</p>
<p>        mInputMethodsPanel.setImeToken(token);</p>
<p>        boolean altBack = (backDisposition == InputMethodService.BACK_DISPOSITION_WILL_DISMISS)</p>
<p>            || ((vis &amp; InputMethodService.IME_VISIBLE) != 0);</p>
<p>        mAltBackButtonEnabledForIme = altBack;</p>
<p>        mCommandQueue.setNavigationIconHints(</p>
<p>                altBack ? (mNavigationIconHints | StatusBarManager.NAVIGATION_HINT_BACK_ALT)</p>
<p>                        : (mNavigationIconHints &amp; ~StatusBarManager.NAVIGATION_HINT_BACK_ALT));</p>
<p>        if (FAKE_SPACE_BAR) {</p>
<p>            mFakeSpaceBar.setVisibility(((vis &amp; InputMethodService.IME_VISIBLE) != 0)</p>
<p>                    ? View.VISIBLE : View.GONE);</p>
<p>        }</p>
<p>    }</p>
<p>    @Override</p>
<p>    public void onRecentsPanelVisibilityChanged(boolean visible) {</p>
<p>        boolean altBack = visible || mAltBackButtonEnabledForIme;</p>
<p>        mCommandQueue.setNavigationIconHints(</p>
<p>                altBack ? (mNavigationIconHints | StatusBarManager.NAVIGATION_HINT_BACK_ALT)</p>
<p>                        : (mNavigationIconHints &amp; ~StatusBarManager.NAVIGATION_HINT_BACK_ALT));</p>
<p>    }</p>
<p>    @Override</p>
<p>    public void setHardKeyboardStatus(boolean available, boolean enabled) {</p>
<p>        if (DEBUG) {</p>
<p>            Slog.d(TAG, &quot;Set hard keyboard status: available=&quot; + available</p>
<p>                    + &quot;, enabled=&quot; + enabled);</p>
<p>        }</p>
<p>        mInputMethodSwitchButton.setHardKeyboardStatus(available);</p>
<p>        updateNotificationIcons();</p>
<p>        mInputMethodsPanel.setHardKeyboardStatus(available, enabled);</p>
<p>    }</p>
<p>    @Override</p>
<p>    public void onHardKeyboardEnabledChange(boolean enabled) {</p>
<p>        try {</p>
<p>            mBarService.setHardKeyboardEnabled(enabled);</p>
<p>        } catch (RemoteException ex) {</p>
<p>        }</p>
<p>    }</p>
<p>    private boolean isImmersive() {</p>
<p>        try {</p>
<p>            return ActivityManagerNative.getDefault().isTopActivityImmersive();</p>
<p>            //Slog.d(TAG, &quot;Top activity is &quot; + (immersive?&quot;immersive&quot;:&quot;not immersive&quot;));</p>
<p>        } catch (RemoteException ex) {</p>
<p>            // the end is nigh</p>
<p>            return false;</p>
<p>        }</p>
<p>    }</p>
<p>    @Override</p>
<p>    protected void setAreThereNotifications() {</p>
<p>        if (mNotificationPanel != null) {</p>
<p>            mNotificationPanel.setClearable(isDeviceProvisioned() &amp;&amp; mNotificationData.hasClearableItems());</p>
<p>        }</p>
<p>    }</p>
<p>    private View.OnClickListener mOnClickListener = new View.OnClickListener() {</p>
<p>        public void onClick(View v) {</p>
<p>            if (v == mRecentButton) {</p>
<p>                onClickRecentButton();</p>
<p>            } else if (v == mInputMethodSwitchButton) {</p>
<p>                onClickInputMethodSwitchButton();</p>
<p>            } else if (v == mCompatModeButton) {</p>
<p>                onClickCompatModeButton();</p>
<p>            }</p>
<p>        }</p>
<p>    };</p>
<p>    public void onClickRecentButton() {</p>
<p>        if (DEBUG) Slog.d(TAG, &quot;clicked recent apps; disabled=&quot; + mDisabled);</p>
<p>        if ((mDisabled &amp; StatusBarManager.DISABLE_EXPAND) == 0) {</p>
<p>            int msg = (mRecentsPanel.getVisibility() == View.VISIBLE)</p>
<p>                ? MSG_CLOSE_RECENTS_PANEL : MSG_OPEN_RECENTS_PANEL;</p>
<p>            mHandler.removeMessages(msg);</p>
<p>            mHandler.sendEmptyMessage(msg);</p>
<p>        }</p>
<p>    }</p>
<p>    public void onClickInputMethodSwitchButton() {</p>
<p>        if (DEBUG) Slog.d(TAG, &quot;clicked input methods panel; disabled=&quot; + mDisabled);</p>
<p>        int msg = (mInputMethodsPanel.getVisibility() == View.GONE) ?</p>
<p>                MSG_OPEN_INPUT_METHODS_PANEL : MSG_CLOSE_INPUT_METHODS_PANEL;</p>
<p>        mHandler.removeMessages(msg);</p>
<p>        mHandler.sendEmptyMessage(msg);</p>
<p>    }</p>
<p>    public void onClickCompatModeButton() {</p>
<p>        int msg = (mCompatModePanel.getVisibility() == View.GONE) ?</p>
<p>                MSG_OPEN_COMPAT_MODE_PANEL : MSG_CLOSE_COMPAT_MODE_PANEL;</p>
<p>        mHandler.removeMessages(msg);</p>
<p>        mHandler.sendEmptyMessage(msg);</p>
<p>    }</p>
<p>    private class NotificationTriggerTouchListener implements View.OnTouchListener {</p>
<p>        VelocityTracker mVT;</p>
<p>        float mInitialTouchX, mInitialTouchY;</p>
<p>        int mTouchSlop;</p>
<p>        public NotificationTriggerTouchListener() {</p>
<p>            mTouchSlop = ViewConfiguration.get(getContext()).getScaledTouchSlop();</p>
<p>        }</p>
<p>        private Runnable mHiliteOnR = new Runnable() { public void run() {</p>
<p>            mNotificationArea.setBackgroundResource(</p>
<p>                com.android.internal.R.drawable.list_selector_pressed_holo_dark);</p>
<p>        }};</p>
<p>        public void hilite(final boolean on) {</p>
<p>            if (on) {</p>
<p>                mNotificationArea.postDelayed(mHiliteOnR, 100);</p>
<p>            } else {</p>
<p>                mNotificationArea.removeCallbacks(mHiliteOnR);</p>
<p>                mNotificationArea.setBackgroundDrawable(null);</p>
<p>            }</p>
<p>        }</p>
<p>        public boolean onTouch(View v, MotionEvent event) {</p>
<p>//            Slog.d(TAG, String.format(&quot;touch: (%.1f, %.1f) initial: (%.1f, %.1f)&quot;,</p>
<p>//                        event.getX(),</p>
<p>//                        event.getY(),</p>
<p>//                        mInitialTouchX,</p>
<p>//                        mInitialTouchY));</p>
<p>            if ((mDisabled &amp; StatusBarManager.DISABLE_EXPAND) != 0) {</p>
<p>                return true;</p>
<p>            }</p>
<p>            final int action = event.getAction();</p>
<p>            switch (action) {</p>
<p>                case MotionEvent.ACTION_DOWN:</p>
<p>                    mVT = VelocityTracker.obtain();</p>
<p>                    mInitialTouchX = event.getX();</p>
<p>                    mInitialTouchY = event.getY();</p>
<p>                    hilite(true);</p>
<p>                    // fall through</p>
<p>                case MotionEvent.ACTION_OUTSIDE:</p>
<p>                case MotionEvent.ACTION_MOVE:</p>
<p>                    // check for fling</p>
<p>                    if (mVT != null) {</p>
<p>                        mVT.addMovement(event);</p>
<p>                        mVT.computeCurrentVelocity(1000); // pixels per second</p>
<p>                        // require a little more oomph once we’re already in peekaboo mode</p>
<p>                        if (mVT.getYVelocity() &lt; -mNotificationFlingVelocity) {</p>
<p>                            animateExpand();</p>
<p>                            visibilityChanged(true);</p>
<p>                            hilite(false);</p>
<p>                            mVT.recycle();</p>
<p>                            mVT = null;</p>
<p>                        }</p>
<p>                    }</p>
<p>                    return true;</p>
<p>                case MotionEvent.ACTION_UP:</p>
<p>                case MotionEvent.ACTION_CANCEL:</p>
<p>                    hilite(false);</p>
<p>                    if (mVT != null) {</p>
<p>                        if (action == MotionEvent.ACTION_UP</p>
<p>                         // was this a sloppy tap?</p>
<p>                         &amp;&amp; Math.abs(event.getX() - mInitialTouchX) &lt; mTouchSlop</p>
<p>                         &amp;&amp; Math.abs(event.getY() - mInitialTouchY) &lt; (mTouchSlop / 3)</p>
<p>                         // dragging off the bottom doesn’t count</p>
<p>                         &amp;&amp; (int)event.getY() &lt; v.getBottom()) {</p>
<p>                            animateExpand();</p>
<p>                            visibilityChanged(true);</p>
<p>                            v.sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);</p>
<p>                            v.playSoundEffect(SoundEffectConstants.CLICK);</p>
<p>                        }</p>
<p>                        mVT.recycle();</p>
<p>                        mVT = null;</p>
<p>                        return true;</p>
<p>                    }</p>
<p>            }</p>
<p>            return false;</p>
<p>        }</p>
<p>    }</p>
<p>    public void resetNotificationPeekFadeTimer() {</p>
<p>        if (DEBUG) {</p>
<p>            Slog.d(TAG, &quot;setting peek fade timer for &quot; + NOTIFICATION_PEEK_FADE_DELAY</p>
<p>                + &quot;ms from now&quot;);</p>
<p>        }</p>
<p>        mHandler.removeMessages(MSG_CLOSE_NOTIFICATION_PEEK);</p>
<p>        mHandler.sendEmptyMessageDelayed(MSG_CLOSE_NOTIFICATION_PEEK,</p>
<p>                NOTIFICATION_PEEK_FADE_DELAY);</p>
<p>    }</p>
<p>    private class NotificationIconTouchListener implements View.OnTouchListener {</p>
<p>        VelocityTracker mVT;</p>
<p>        int mPeekIndex;</p>
<p>        float mInitialTouchX, mInitialTouchY;</p>
<p>        int mTouchSlop;</p>
<p>        public NotificationIconTouchListener() {</p>
<p>            mTouchSlop = ViewConfiguration.get(getContext()).getScaledTouchSlop();</p>
<p>        }</p>
<p>        public boolean onTouch(View v, MotionEvent event) {</p>
<p>            boolean peeking = mNotificationPeekWindow.getVisibility() != View.GONE;</p>
<p>            boolean panelShowing = mNotificationPanel.isShowing();</p>
<p>            if (panelShowing) return false;</p>
<p>            int numIcons = mIconLayout.getChildCount();</p>
<p>            int newPeekIndex = (int)(event.getX() * numIcons / mIconLayout.getWidth());</p>
<p>            if (newPeekIndex &gt; numIcons - 1) newPeekIndex = numIcons - 1;</p>
<p>            else if (newPeekIndex &lt; 0) newPeekIndex = 0;</p>
<p>            final int action = event.getAction();</p>
<p>            switch (action) {</p>
<p>                case MotionEvent.ACTION_DOWN:</p>
<p>                    mVT = VelocityTracker.obtain();</p>
<p>                    mInitialTouchX = event.getX();</p>
<p>                    mInitialTouchY = event.getY();</p>
<p>                    mPeekIndex = -1;</p>
<p>                    // fall through</p>
<p>                case MotionEvent.ACTION_OUTSIDE:</p>
<p>                case MotionEvent.ACTION_MOVE:</p>
<p>                    // peek and switch icons if necessary</p>
<p>                    if (newPeekIndex != mPeekIndex) {</p>
<p>                        mPeekIndex = newPeekIndex;</p>
<p>                        if (DEBUG) Slog.d(TAG, &quot;will peek at notification #&quot; + mPeekIndex);</p>
<p>                        Message peekMsg = mHandler.obtainMessage(MSG_OPEN_NOTIFICATION_PEEK);</p>
<p>                        peekMsg.arg1 = mPeekIndex;</p>
<p>                        mHandler.removeMessages(MSG_OPEN_NOTIFICATION_PEEK);</p>
<p>                        if (peeking) {</p>
<p>                            // no delay if we’re scrubbing left-right</p>
<p>                            mHandler.sendMessage(peekMsg);</p>
<p>                        } else {</p>
<p>                            // wait for fling</p>
<p>                            mHandler.sendMessageDelayed(peekMsg, NOTIFICATION_PEEK_HOLD_THRESH);</p>
<p>                        }</p>
<p>                    }</p>
<p>                    // check for fling</p>
<p>                    if (mVT != null) {</p>
<p>                        mVT.addMovement(event);</p>
<p>                        mVT.computeCurrentVelocity(1000); // pixels per second</p>
<p>                        // require a little more oomph once we’re already in peekaboo mode</p>
<p>                        if (!panelShowing &amp;&amp; (</p>
<p>                               (peeking &amp;&amp; mVT.getYVelocity() &lt; -mNotificationFlingVelocity*3)</p>
<p>                            || (mVT.getYVelocity() &lt; -mNotificationFlingVelocity))) {</p>
<p>                            mHandler.removeMessages(MSG_OPEN_NOTIFICATION_PEEK);</p>
<p>                            mHandler.removeMessages(MSG_OPEN_NOTIFICATION_PANEL);</p>
<p>                            mHandler.sendEmptyMessage(MSG_CLOSE_NOTIFICATION_PEEK);</p>
<p>                            mHandler.sendEmptyMessage(MSG_OPEN_NOTIFICATION_PANEL);</p>
<p>                        }</p>
<p>                    }</p>
<p>                    return true;</p>
<p>                case MotionEvent.ACTION_UP:</p>
<p>                case MotionEvent.ACTION_CANCEL:</p>
<p>                    mHandler.removeMessages(MSG_OPEN_NOTIFICATION_PEEK);</p>
<p>                    if (!peeking) {</p>
<p>                        if (action == MotionEvent.ACTION_UP</p>
<p>                                // was this a sloppy tap?</p>
<p>                                &amp;&amp; Math.abs(event.getX() - mInitialTouchX) &lt; mTouchSlop</p>
<p>                                &amp;&amp; Math.abs(event.getY() - mInitialTouchY) &lt; (mTouchSlop / 3)</p>
<p>                                // dragging off the bottom doesn’t count</p>
<p>                                &amp;&amp; (int)event.getY() &lt; v.getBottom()) {</p>
<p>                            Message peekMsg = mHandler.obtainMessage(MSG_OPEN_NOTIFICATION_PEEK);</p>
<p>                            peekMsg.arg1 = mPeekIndex;</p>
<p>                            mHandler.removeMessages(MSG_OPEN_NOTIFICATION_PEEK);</p>
<p>                            mHandler.sendMessage(peekMsg);</p>
<p>                            v.sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);</p>
<p>                            v.playSoundEffect(SoundEffectConstants.CLICK);</p>
<p>                            peeking = true; // not technically true yet, but the next line will run</p>
<p>                        }</p>
<p>                    }</p>
<p>                    if (peeking) {</p>
<p>                        resetNotificationPeekFadeTimer();</p>
<p>                    }</p>
<p>                    mVT.recycle();</p>
<p>                    mVT = null;</p>
<p>                    return true;</p>
<p>            }</p>
<p>            return false;</p>
<p>        }</p>
<p>    }</p>
<p>    private void reloadAllNotificationIcons() {</p>
<p>        if (mIconLayout == null) return;</p>
<p>        mIconLayout.removeAllViews();</p>
<p>        updateNotificationIcons();</p>
<p>    }</p>
<p>    @Override</p>
<p>    protected void updateNotificationIcons() {</p>
<p>        // XXX: need to implement a new limited linear layout class</p>
<p>        // to avoid removing &amp; readding everything</p>
<p>        if (mIconLayout == null) return;</p>
<p>        // first, populate the main notification panel</p>
<p>        loadNotificationPanel();</p>
<p>        final LinearLayout.LayoutParams params</p>
<p>            = new LinearLayout.LayoutParams(mIconSize + 2*mIconHPadding, mNaturalBarHeight);</p>
<p>        // alternate behavior in DND mode</p>
<p>        if (mNotificationDNDMode) {</p>
<p>            if (mIconLayout.getChildCount() == 0) {</p>
<p>                final Notification dndNotification = new Notification.Builder(mContext)</p>
<p>                    .setContentTitle(mContext.getText(R.string.notifications_off_title))</p>
<p>                    .setContentText(mContext.getText(R.string.notifications_off_text))</p>
<p>                    .setSmallIcon(R.drawable.ic_notification_dnd)</p>
<p>                    .setOngoing(true)</p>
<p>                    .getNotification();</p>
<p>                final StatusBarIconView iconView = new StatusBarIconView(mContext, &quot;_dnd&quot;,</p>
<p>                        dndNotification);</p>
<p>                iconView.setImageResource(R.drawable.ic_notification_dnd);</p>
<p>                iconView.setScaleType(ImageView.ScaleType.CENTER_INSIDE);</p>
<p>                iconView.setPadding(mIconHPadding, 0, mIconHPadding, 0);</p>
<p>                mNotificationDNDDummyEntry = new NotificationData.Entry(</p>
<p>                        null,</p>
<p>                        new StatusBarNotification(&quot;&quot;, 0, &quot;&quot;, 0, 0, Notification.PRIORITY_MAX, dndNotification),</p>
<p>                        iconView);</p>
<p>                mIconLayout.addView(iconView, params);</p>
<p>            }</p>
<p>            return;</p>
<p>        } else if (0 != (mDisabled &amp; StatusBarManager.DISABLE_NOTIFICATION_ICONS)) {</p>
<p>            // if icons are disabled but we’re not in DND mode, this is probably Setup and we should</p>
<p>            // just leave the area totally empty</p>
<p>            return;</p>
<p>        }</p>
<p>        int N = mNotificationData.size();</p>
<p>        if (DEBUG) {</p>
<p>            Slog.d(TAG, &quot;refreshing icons: &quot; + N + &quot; notifications, mIconLayout=&quot; + mIconLayout);</p>
<p>        }</p>
<p>        ArrayList&lt;View&gt; toShow = new ArrayList&lt;View&gt;();</p>
<p>        // Extra Special Icons</p>
<p>        // The IME switcher and compatibility mode icons take the place of notifications. You didn’t</p>
<p>        // need to see all those new emails, did you?</p>
<p>        int maxNotificationIconsCount = mMaxNotificationIcons;</p>
<p>        if (mInputMethodSwitchButton.getVisibility() != View.GONE) maxNotificationIconsCount –;</p>
<p>        if (mCompatModeButton.getVisibility()        != View.GONE) maxNotificationIconsCount –;</p>
<p>        final boolean provisioned = isDeviceProvisioned();</p>
<p>        // If the device hasn’t been through Setup, we only show system notifications</p>
<p>        for (int i=0; toShow.size()&lt; maxNotificationIconsCount; i++) {</p>
<p>            if (i &gt;= N) break;</p>
<p>            Entry ent = mNotificationData.get(N-i-1);</p>
<p>            if ((provisioned &amp;&amp; ent.notification.score &gt;= HIDE_ICONS_BELOW_SCORE)</p>
<p>                    || showNotificationEvenIfUnprovisioned(ent.notification)) {</p>
<p>                toShow.add(ent.icon);</p>
<p>            }</p>
<p>        }</p>
<p>        ArrayList&lt;View&gt; toRemove = new ArrayList&lt;View&gt;();</p>
<p>        for (int i=0; i&lt;mIconLayout.getChildCount(); i++) {</p>
<p>            View child = mIconLayout.getChildAt(i);</p>
<p>            if (!toShow.contains(child)) {</p>
<p>                toRemove.add(child);</p>
<p>            }</p>
<p>        }</p>
<p>        for (View remove : toRemove) {</p>
<p>            mIconLayout.removeView(remove);</p>
<p>        }</p>
<p>        for (int i=0; i&lt;toShow.size(); i++) {</p>
<p>            View v = toShow.get(i);</p>
<p>            v.setPadding(mIconHPadding, 0, mIconHPadding, 0);</p>
<p>            if (v.getParent() == null) {</p>
<p>                mIconLayout.addView(v, i, params);</p>
<p>            }</p>
<p>        }</p>
<p>        if(toShow.size()&gt;0)</p>
<p>        {</p>
<p>            mFeedbackIconArea.setVisibility(View.VISIBLE);</p>
<p>        }</p>
<p>    }</p>
<p>    private void loadNotificationPanel() {</p>
<p>        int N = mNotificationData.size();</p>
<p>        ArrayList&lt;View&gt; toShow = new ArrayList&lt;View&gt;();</p>
<p>        final boolean provisioned = isDeviceProvisioned();</p>
<p>        // If the device hasn’t been through Setup, we only show system notifications</p>
<p>        for (int i=0; i&lt;N; i++) {</p>
<p>            Entry ent = mNotificationData.get(N-i-1);</p>
<p>            if (provisioned || showNotificationEvenIfUnprovisioned(ent.notification)) {</p>
<p>                toShow.add(ent.row);</p>
<p>            }</p>
<p>        }</p>
<p>        ArrayList&lt;View&gt; toRemove = new ArrayList&lt;View&gt;();</p>
<p>        for (int i=0; i&lt;mPile.getChildCount(); i++) {</p>
<p>            View child = mPile.getChildAt(i);</p>
<p>            if (!toShow.contains(child)) {</p>
<p>                toRemove.add(child);</p>
<p>            }</p>
<p>        }</p>
<p>        for (View remove : toRemove) {</p>
<p>            mPile.removeView(remove);</p>
<p>        }</p>
<p>        for (int i=0; i&lt;toShow.size(); i++) {</p>
<p>            View v = toShow.get(i);</p>
<p>            if (v.getParent() == null) {</p>
<p>                // the notification panel has the most important things at the bottom</p>
<p>                mPile.addView(v, Math.min(toShow.size()-1-i, mPile.getChildCount()));</p>
<p>            }</p>
<p>        }</p>
<p>        mNotificationPanel.setNotificationCount(toShow.size());</p>
<p>        mNotificationPanel.setSettingsEnabled(isDeviceProvisioned());</p>
<p>        mNotificationPanel.updatePanelModeButtons();</p>
<p>    }</p>
<p>    @Override</p>
<p>    protected void workAroundBadLayerDrawableOpacity(View v) {</p>
<p>        Drawable bgd = v.getBackground();</p>
<p>        if (!(bgd instanceof LayerDrawable)) return;</p>
<p>        LayerDrawable d = (LayerDrawable) bgd;</p>
<p>        v.setBackgroundDrawable(null);</p>
<p>        d.setOpacity(PixelFormat.TRANSLUCENT);</p>
<p>        v.setBackgroundDrawable(d);</p>
<p>    }</p>
<p>    public void clearAll() {</p>
<p>        try {</p>
<p>            mBarService.onClearAllNotifications();</p>
<p>        } catch (RemoteException ex) {</p>
<p>            // system process is dead if we’re here.</p>
<p>        }</p>
<p>        animateCollapse();</p>
<p>        visibilityChanged(false);</p>
<p>    }</p>
<p>    private BroadcastReceiver mBroadcastReceiver = new BroadcastReceiver() {</p>
<p>        public void onReceive(Context context, Intent intent) {</p>
<p>            String action = intent.getAction();</p>
<p>            if (Intent.ACTION_CLOSE_SYSTEM_DIALOGS.equals(action)</p>
<p>                || Intent.ACTION_SCREEN_OFF.equals(action)) {</p>
<p>                int flags = CommandQueue.FLAG_EXCLUDE_NONE;</p>
<p>                if (Intent.ACTION_CLOSE_SYSTEM_DIALOGS.equals(action)) {</p>
<p>                    String reason = intent.getStringExtra(&quot;reason&quot;);</p>
<p>                    if (reason != null &amp;&amp; reason.equals(SYSTEM_DIALOG_REASON_RECENT_APPS)) {</p>
<p>                        flags |= CommandQueue.FLAG_EXCLUDE_RECENTS_PANEL;</p>
<p>                    }</p>
<p>                }</p>
<p>                if (Intent.ACTION_SCREEN_OFF.equals(action)) {</p>
<p>                    // If we’re turning the screen off, we want to hide the</p>
<p>                    // recents panel with no animation</p>
<p>                    // TODO: hide other things, like the notification tray,</p>
<p>                    // with no animation as well</p>
<p>                    mRecentsPanel.show(false, false);</p>
<p>                    flags |= CommandQueue.FLAG_EXCLUDE_RECENTS_PANEL;</p>
<p>                }</p>
<p>                animateCollapse(flags);</p>
<p>            }</p>
<p>        }</p>
<p>    };</p>
<p>    public void dump(FileDescriptor fd, PrintWriter pw, String[] args) {</p>
<p>        pw.print(&quot;mDisabled=0x&quot;);</p>
<p>        pw.println(Integer.toHexString(mDisabled));</p>
<p>        pw.println(&quot;mNetworkController:&quot;);</p>
<p>        mNetworkController.dump(fd, pw, args);</p>
<p>    }</p>
<p>    @Override</p>
<p>    protected boolean isTopNotification(ViewGroup parent, NotificationData.Entry entry) {</p>
<p>        if (parent == null || entry == null) return false;</p>
<p>        return parent.indexOfChild(entry.row) == parent.getChildCount()-1;</p>
<p>    }</p>
<p>    @Override</p>
<p>    protected void haltTicker() {</p>
<p>        mTicker.halt();</p>
<p>    }</p>
<p>    @Override</p>
<p>    protected void updateExpandedViewPos(int expandedPosition) {</p>
<p>    }</p>
<p>    @Override</p>
<p>    protected boolean shouldDisableNavbarGestures() {</p>
<p>        return mNotificationPanel.getVisibility() == View.VISIBLE</p>
<p>                || (mDisabled &amp; StatusBarManager.DISABLE_HOME) != 0;</p>
<p>    }</p>
<p>}</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/12/31/%E7%83%82%E7%AC%94%E5%A4%B4/systemUI%20%E9%9F%B3%E9%87%8F%E6%8E%A7%E5%88%B6%E6%9D%A1/" rel="prev" title="systemUI 音量控制条">
      <i class="fa fa-chevron-left"></i> systemUI 音量控制条
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/12/31/%E7%83%82%E7%AC%94%E5%A4%B4/tar%E5%91%BD%E4%BB%A4/" rel="next" title="tar命令">
      tar命令 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Edward"
      src="/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">Edward</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">553</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Edward</span>
</div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"wxYx0BX9gaKA3XC4LuO2of0v-gzGzoHsz","app_key":"LQMcs6IDIE4YAm10vMsn9IYq","server_url":"https://wxyx0bx9.lc-cn-n1-shared.com","security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
