<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"edward.org.cn","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="禁止系统锁界面 &lt;uses-permission android:name&#x3D;&quot;android.permission.DISABLE_KEYGUARD&quot;&#x2F;&gt; mKeyguardManager &#x3D; (KeyguardManager)Class.this.getSystemService(Context.KEYGUARD_SERVICE);           mKeyg">
<meta property="og:type" content="article">
<meta property="og:title" content="锁屏界面">
<meta property="og:url" content="http://edward.org.cn/2020/12/31/%E7%83%82%E7%AC%94%E5%A4%B4/%E9%94%81%E5%B1%8F%E7%95%8C%E9%9D%A2/index.html">
<meta property="og:site_name" content="点点滴滴">
<meta property="og:description" content="禁止系统锁界面 &lt;uses-permission android:name&#x3D;&quot;android.permission.DISABLE_KEYGUARD&quot;&#x2F;&gt; mKeyguardManager &#x3D; (KeyguardManager)Class.this.getSystemService(Context.KEYGUARD_SERVICE);           mKeyg">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-12-31T06:48:02.114Z">
<meta property="article:modified_time" content="2020-01-16T04:37:33.187Z">
<meta property="article:author" content="Edward">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://edward.org.cn/2020/12/31/%E7%83%82%E7%AC%94%E5%A4%B4/%E9%94%81%E5%B1%8F%E7%95%8C%E9%9D%A2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>锁屏界面 | 点点滴滴</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a92ed22eafce466e7a7b17546bb0dc6f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">点点滴滴</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://edward.org.cn/2020/12/31/%E7%83%82%E7%AC%94%E5%A4%B4/%E9%94%81%E5%B1%8F%E7%95%8C%E9%9D%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.gif">
      <meta itemprop="name" content="Edward">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="点点滴滴">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          锁屏界面
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-31 14:48:02" itemprop="dateCreated datePublished" datetime="2020-12-31T14:48:02+08:00">2020-12-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-01-16 12:37:33" itemprop="dateModified" datetime="2020-01-16T12:37:33+08:00">2020-01-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%83%82%E7%AC%94%E5%A4%B4/" itemprop="url" rel="index"><span itemprop="name">烂笔头</span></a>
                </span>
            </span>

          
            <span id="/2020/12/31/%E7%83%82%E7%AC%94%E5%A4%B4/%E9%94%81%E5%B1%8F%E7%95%8C%E9%9D%A2/" class="post-meta-item leancloud_visitors" data-flag-title="锁屏界面" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>禁止系统锁界面</p>
<p>&lt;uses-permission android:name=&quot;android.permission.DISABLE_KEYGUARD&quot;/&gt;</p>
<p>mKeyguardManager = (KeyguardManager)Class.this.getSystemService(Context.KEYGUARD_SERVICE);  </p>
<p>        mKeyguardLock = mKeyguardManager.newKeyguardLock(&quot;my_lockscreen&quot;);   </p>
<p>        mKeyguardLock.disableKeyguard();  </p>
<p>PhoneWindowManager.java中的interceptKeyBeforeDispatching</p>
<p>final int typeCount = WINDOW_TYPES_WHERE_HOME_DOESNT_WORK.length;  </p>
<p>for (int i=0; i&lt;typeCount; i++) {  </p>
<p>if (type == WINDOW_TYPES_WHERE_HOME_DOESNT_WORK[i]) {  </p>
<p>// don’t do anything, but also don’t pass it to the app  </p>
<p>return -1;  </p>
<p>                    }  </p>
<p>                }  </p>
<p>看注释：如果设置了这两个属性的其中一个，就不做任何处理，home键不对这个app生效；</p>
<p>而WINDOW_TYPES_WHERE_HOME_DOESNT_WORK数据的定义如下：</p>
<p>private static final int[] WINDOW_TYPES_WHERE_HOME_DOESNT_WORK = {  </p>
<p>            WindowManager.LayoutParams.TYPE_SYSTEM_ALERT,  </p>
<p>            WindowManager.LayoutParams.TYPE_SYSTEM_ERROR,  </p>
<p>        };  </p>
<p>在这个界面长按power键，关机界面也弹不出来了</p>
<p>在app 的你要屏蔽home 键的activity 中，只需要添加该标志就可以了  </p>
<p>this.getWindow().setFlags(FLAG_HOMEKEY_DISPATCHED, FLAG_HOMEKEY_DISPATCHED);  </p>
<p>如果要使home 键有效，再 clearFlags 即可。  </p>
<p>getWindow().clearFlags(WindowManager.LayoutParams.FLAG_HOMEKEY_DISPATCHED);  </p>
<p>注意：以上代码要加在setContentView（）之前才行；</p>
<p>这个代码来源于PhoneWindowManager.java这个类的interceptKeyBeforeDispatching（）方法中，</p>
<p>if ((flag &amp; WindowManager.LayoutParams.FLAG_HOMEKEY_DISPATCHED) != 0) {  </p>
<p>                   // the window wants to handle the home key, so dispatch it to it.  </p>
<p>                   return 0;  </p>
<p>               }      </p>
<p>这样设置，有的同学感觉好用，有的同学感觉不好用；</p>
<p>原因：android4.0的源码的PhoneWindowManager.java没有添加上述代码，所以不起作用，</p>
<p>而4.1的源码PhoneWindowManager.java中有这个代码，所以好用，这个请大家看看对应的源码是否有上述代码；</p>
<p>4.2 锁界面</p>
<p>frameworks/base/core/res/res/values/arrays.xml</p>
<p> &lt;array name=&quot;lockscreen_targets_when_soundon&quot;&gt;</p>
<p>        &lt;item&gt;@drawable/ic_lockscreen_unlock&lt;/item&gt;</p>
<p>        &lt;item&gt;@drawable/ic_action_assist_generic&lt;/item&gt;</p>
<p>        &lt;item&gt;@drawable/ic_lockscreen_silent&lt;/item&gt;</p>
<p>        &lt;item&gt;@null&lt;/item&gt;</p>
<p>    &lt;/array&gt;</p>
<p>    &lt;array name=&quot;lockscreen_targets_with_camera&quot;&gt;</p>
<p>        &lt;item&gt;@drawable/ic_lockscreen_unlock&lt;/item&gt;</p>
<p>        &lt;item&gt;@drawable/ic_action_assist_generic&lt;/item&gt;</p>
<p>        &lt;item&gt;@drawable/ic_lockscreen_camera&lt;/item&gt;</p>
<p>        &lt;item&gt;@null&lt;/item&gt;</p>
<p>    &lt;/array&gt;</p>
<p>    &lt;array name=&quot;lockscreen_targets_unlock_only&quot;&gt;</p>
<p>        &lt;item&gt;@*android:drawable/ic_lockscreen_unlock&lt;/item&gt;</p>
<p>    &lt;/array&gt;</p>
<p>frameworks/base/core/res/res/layout/keyguard_glow_pad_view.xml</p>
<p>prvandroid:targetDrawables=&quot;@array/lockscreen_targets_unlock_only&quot;</p>
<p>这个圆形的解锁界面，左边是照相机，右边是解锁。下面我们来说说这个功能的具体实现，以及怎么修改成为上下左右四个方向的解锁界面。</p>
<p>Step1：先看LockScreen.java这个类加载的布局</p>
<p>[java] view plaincopyprint?</p>
<p>inflater.inflate(R.layout.keyguard_screen_tab_unlock, this, true);  </p>
<p>然后看对应的布局文件：</p>
<p>[html] view plaincopyprint?</p>
<p>&lt;com.android.internal.widget.multiwaveview.MultiWaveView  </p>
<p>android:id=&quot;@+id/unlock_widget&quot;  </p>
<p>android:orientation=&quot;horizontal&quot;  </p>
<p>android:layout_width=&quot;match_parent&quot;  </p>
<p>android:layout_height=&quot;match_parent&quot;  </p>
<p>android:layout_alignParentBottom=&quot;true&quot;  </p>
<p>android:targetDrawables=&quot;@array/lockscreen_targets_with_camera&quot;  </p>
<p>android:targetDescriptions=&quot;@array/lockscreen_target_descriptions_with_camera&quot;  </p>
<p>android:directionDescriptions=&quot;@array/lockscreen_direction_descriptions&quot;  </p>
<p>android:handleDrawable=&quot;@drawable/ic_lockscreen_handle&quot;  </p>
<p>android:waveDrawable=&quot;@drawable/ic_lockscreen_outerring&quot;  </p>
<p>android:outerRadius=&quot;@dimen/multiwaveview_target_placement_radius&quot;  </p>
<p>android:snapMargin=&quot;@dimen/multiwaveview_snap_margin&quot;  </p>
<p>android:hitRadius=&quot;@dimen/multiwaveview_hit_radius&quot;  </p>
<p>android:rightChevronDrawable=&quot;@drawable/ic_lockscreen_chevron_right&quot;  </p>
<p>android:horizontalOffset=&quot;0dip&quot;  </p>
<p>android:verticalOffset=&quot;60dip&quot;  </p>
<p>android:feedbackCount=&quot;3&quot;  </p>
<p>android:vibrationDuration=&quot;20&quot;  </p>
<p>/&gt;  </p>
<p>下面我们来细细研究这些属性的含义：</p>
<p>        空行上面的属性都是android常用的一些属性，相信不用我说了；</p>
<p>   (1) android:targetDrawables=&quot;@array/lockscreen_targets_with_camera&quot;</p>
<p>        这个属性表示目标的图标有几个，android默认是2个，不过我们可以修改这个array的值，我们看看这个值</p>
<p>[html] view plaincopyprint?</p>
<p>&lt;array name=&quot;lockscreen_targets_with_camera&quot;&gt;  </p>
<p>&lt;item&gt;@drawable/ic_lockscreen_unlock&lt;/item&gt;  </p>
<p>&lt;item&gt;@null&lt;/item&gt;  </p>
<p>&lt;item&gt;@drawable/ic_lockscreen_camera&lt;/item&gt;  </p>
<p>&lt;item&gt;@null&lt;/item&gt;  </p>
<p>&lt;/array&gt;  </p>
<p>        我相信你这样表示就应该明白该怎么修改了，这四个item分别对应圆圈的位置是右，上，左，下。</p>
<p>        想加几个图片，这个完全取决你自己，像小米的锁屏是四个，就是修改的这里。其实也没什么的，so easy！</p>
<p>  (2) android:targetDescriptions=&quot;@array/lockscreen_target_descriptions_with_camera&quot;</p>
<p>        这个属性是对应的描述语言，</p>
<p>[html] view plaincopyprint?</p>
<p>&lt;array name=&quot;lockscreen_target_descriptions_with_camera&quot;&gt;  </p>
<p>&lt;item&gt;@string/description_target_unlock&lt;/item&gt;  </p>
<p>&lt;item&gt;@null&lt;/item&gt;  </p>
<p>&lt;item&gt;@string/description_target_camera&lt;/item&gt;  </p>
<p>&lt;item&gt;@null&lt;/item&gt;  </p>
<p>&lt;/array&gt;  </p>
<p>        你要是修改（1）的话，你也就相应的修改这些字符串就可以了。这个没什么可说的了。</p>
<p>  (3) android:directionDescriptions=&quot;@array/lockscreen_direction_descriptions&quot;</p>
<p>       这个属性和（2）差不多，</p>
<p>[html] view plaincopyprint?</p>
<p>&lt;array name=&quot;lockscreen_direction_descriptions&quot;&gt;  </p>
<p>&lt;item&gt;@string/description_direction_right&lt;/item&gt;  </p>
<p>&lt;item&gt;@null&lt;/item&gt;  </p>
<p>&lt;item&gt;@string/description_direction_left&lt;/item&gt;  </p>
<p>&lt;item&gt;@null&lt;/item&gt;  </p>
<p>&lt;/array&gt;  </p>
<p>       这个表示的含义就是：对应四个位置，右，上，左，下这四个位置，提示语言：向哪个方向滑的问题。</p>
<p>  (4) android:handleDrawable=&quot;@drawable/ic_lockscreen_handle&quot;<br>       这个属性对应的就是中间的那个解锁的图标，对应2张图片，一张选中的图片，一张默认没有选中的图片。</p>
<p>[html] view plaincopyprint?</p>
<p>&lt;selector xmlns:android=&quot;<a target="_blank" rel="noopener" href="http://schemas.android.com/apk/res/android">http://schemas.android.com/apk/res/android</a>&quot;&gt;  </p>
<p>&lt;item  </p>
<p>android:state_enabled=&quot;true&quot;  </p>
<p>android:state_active=&quot;false&quot;  </p>
<p>android:state_focused=&quot;false&quot;  </p>
<p>android:drawable=&quot;@drawable/ic_lockscreen_handle_normal&quot; /&gt;  </p>
<p>&lt;item  </p>
<p>android:state_enabled=&quot;true&quot;  </p>
<p>android:state_active=&quot;true&quot;  </p>
<p>android:state_focused=&quot;false&quot;  </p>
<p>android:drawable=&quot;@drawable/ic_lockscreen_handle_pressed&quot; /&gt;  </p>
<p>&lt;/selector&gt;  </p>
<p>  (5) android:waveDrawable=&quot;@drawable/ic_lockscreen_outerring&quot;</p>
<p>       这个属性对应的就是最外面的圆圈，是用shape属性画出来的。如：</p>
<p>[html] view plaincopyprint?</p>
<p>&lt;shape xmlns:android=&quot;<a target="_blank" rel="noopener" href="http://schemas.android.com/apk/res/android">http://schemas.android.com/apk/res/android</a>&quot;  </p>
<p>android:shape=&quot;oval&quot;  </p>
<p>&gt;  </p>
<p>&lt;size android:height=&quot;@dimen/keyguard_lockscreen_outerring_diameter&quot; android:width=&quot;@dimen/keyguard_lockscreen_outerring_diameter&quot; /&gt;  </p>
<p>&lt;solid android:color=&quot;#00000000&quot; /&gt;  </p>
<p>&lt;stroke android:color=&quot;#1affffff&quot; android:width=&quot;2dp&quot; /&gt;  </p>
<p>&lt;/shape&gt;  </p>
<p>         以上的这些值都可以修改的。</p>
<p>  (6) android:outerRadius=&quot;@dimen/multiwaveview_target_placement_radius&quot;</p>
<p>       这个属性表示默认圆的半径的大小；</p>
<p>[html] view plaincopyprint?</p>
<p>&lt;!– Default target placement radius for MultiWaveView –&gt;  </p>
<p>&lt;dimen name=&quot;multiwaveview_target_placement_radius&quot;&gt;135dip&lt;/dimen&gt;  </p>
<p>  (7) android:snapMargin=&quot;@dimen/multiwaveview_snap_margin&quot;</p>
<p>       这个属性是默认超越MultiWaveView捕捉到目标半径距离  </p>
<p>[html] view plaincopyprint?</p>
<p>&lt;!– Default distance beyond which MultiWaveView snaps to the target radius –&gt;  </p>
<p>&lt;dimen name=&quot;multiwaveview_snap_margin&quot;&gt;20dip&lt;/dimen&gt;  </p>
<p>  (8) android:hitRadius=&quot;@dimen/multiwaveview_hit_radius&quot;</p>
<p>      这个属性表示：每个单元目标预设距离，MultiWaveView认为选中</p>
<p>[html] view plaincopyprint?</p>
<p>&lt;!– Default distance from each snap target that MultiWaveView considers a &quot;hit&quot; –&gt;  </p>
<p>&lt;dimen name=&quot;multiwaveview_hit_radius&quot;&gt;60dip&lt;/dimen&gt;  </p>
<p>  (9)android:rightChevronDrawable=&quot;@drawable/ic_lockscreen_chevron_right&quot;</p>
<p>     这个属性表示：动态画的波纹的图片，这个属性共有四个，分别为，左，上，右，下四个方位的。</p>
<p>  (10) android:horizontalOffset=&quot;0dip&quot;<br>         android:verticalOffset=&quot;60dip&quot;</p>
<p>        这2个属性表示：距离圆圈水平和垂直的距离。你就明白为什么圆的下方少一块的原因了。</p>
<p>  (11) android:feedbackCount=&quot;3&quot;</p>
<p>         表示：反馈数量3个；</p>
<p>  (12) android:vibrationDuration=&quot;20&quot;</p>
<p>          表示：默认震动的时间，20毫秒；</p>
<p>更多属性请参考：core/res/res/values/attrs.xml中</p>
<p>[html] view plaincopyprint?</p>
<p>&lt;!– =============================== –&gt;  </p>
<p>&lt;!– MultiWaveView class attributes –&gt;  </p>
<p>&lt;!– =============================== –&gt;  </p>
<p>&lt;eat-comment /&gt;  </p>
<p>&lt;declare-styleable name=&quot;MultiWaveView&quot;&gt;  </p>
<p>&lt;!– Reference to an array resource that be shown as targets around a circle. –&gt;  </p>
<p>&lt;attr name=&quot;targetDrawables&quot; format=&quot;reference&quot;/&gt;  </p>
<p>&lt;!– Reference to an array resource that be used as description for the targets around the circle. –&gt;  </p>
<p>&lt;attr name=&quot;targetDescriptions&quot; format=&quot;reference&quot;/&gt;  </p>
<p>&lt;!– Reference to an array resource that be used to announce the directions with targets around the circle. –&gt;  </p>
<p>&lt;attr name=&quot;directionDescriptions&quot; format=&quot;reference&quot;/&gt;  </p>
<p>&lt;!– Sets a drawable as the drag center. –&gt;  </p>
<p>&lt;attr name=&quot;handleDrawable&quot; format=&quot;reference&quot; /&gt;  </p>
<p>&lt;!– Drawable to use for chevron animation on the left. May be null. –&gt;  </p>
<p>&lt;attr name=&quot;leftChevronDrawable&quot; format=&quot;reference&quot; /&gt;  </p>
<p>&lt;!– Drawable to use for chevron animation on the right. May be null. –&gt;  </p>
<p>&lt;attr name=&quot;rightChevronDrawable&quot; format=&quot;reference&quot; /&gt;  </p>
<p>&lt;!– Drawable to use for chevron animation on the top. May be null. –&gt;  </p>
<p>&lt;attr name=&quot;topChevronDrawable&quot; format=&quot;reference&quot; /&gt;  </p>
<p>&lt;!– Drawable to use for chevron animation on the bottom. May be null. –&gt;  </p>
<p>&lt;attr name=&quot;bottomChevronDrawable&quot; format=&quot;reference&quot; /&gt;  </p>
<p>&lt;!– Drawable to use for wave ripple animation. –&gt;  </p>
<p>&lt;attr name=&quot;waveDrawable&quot; format=&quot;reference&quot; /&gt;  </p>
<p>&lt;!– Outer radius of target circle. Icons will be drawn on this circle. –&gt;  </p>
<p>&lt;attr name=&quot;outerRadius&quot; format=&quot;dimension&quot; /&gt;  </p>
<p>&lt;!– Size of target radius. Points within this distance of target center is a &quot;hit&quot;. –&gt;  </p>
<p>&lt;attr name=&quot;hitRadius&quot; format=&quot;dimension&quot; /&gt;  </p>
<p>&lt;!– Tactile feedback duration for actions. Set to ‘0’ for no vibration. –&gt;  </p>
<p>&lt;attr name=&quot;vibrationDuration&quot; format=&quot;integer&quot;/&gt;  </p>
<p>&lt;!– How close we need to be before snapping to a target. –&gt;  </p>
<p>&lt;attr name=&quot;snapMargin&quot; format=&quot;dimension&quot; /&gt;  </p>
<p>&lt;!– Number of waves/chevrons to show in animation. –&gt;  </p>
<p>&lt;attr name=&quot;feedbackCount&quot; format=&quot;integer&quot; /&gt;  </p>
<p>&lt;!– Used to shift center of pattern vertically. –&gt;  </p>
<p>&lt;attr name=&quot;verticalOffset&quot; format=&quot;dimension&quot; /&gt;  </p>
<p>&lt;!– Used to shift center of pattern horizontally. –&gt;  </p>
<p>&lt;attr name=&quot;horizontalOffset&quot; format=&quot;dimension&quot; /&gt;  </p>
<p>&lt;/declare-styleable&gt;  </p>
<p>这些属性能帮助你自定义自己的锁屏，如果不够的话，你也可以自己添加，然后在MultiWaveView.java中添加自己的方法或属性。</p>
<p>我们来说说Android4.2锁屏的流程：咱们一步一步来说：</p>
<p>Step1：先看第一次开机的加载锁屏的过程，通过PhoneWindowManager.java这个类的systemReady（）这个方法，当系统开机准备好的情况下会调用这个方法，如下：</p>
<p>[java] view plaincopyprint?</p>
<p>public void systemReady() {  </p>
<p>if (mKeyguardMediator != null) {  </p>
<p>// tell the keyguard  </p>
<p>           mKeyguardMediator.onSystemReady();  </p>
<p>       }  </p>
<p>synchronized (mLock) {  </p>
<p>           updateOrientationListenerLp();  </p>
<p>           mSystemReady = true;  </p>
<p>           mHandler.post(new Runnable() {  </p>
<p>public void run() {  </p>
<p>                   updateSettings();  </p>
<p>               }  </p>
<p>           });  </p>
<p>       }  </p>
<p>   }  </p>
<p>Step2：看注释就知道下一步该干什么了，告诉锁屏的管理者，我准备好了，该你来控制加载锁屏界面了。接着调用到了KeyguardViewMediator.java这个类的onSystemReady（）方法，如下：</p>
<p>[java] view plaincopyprint?</p>
<p>/** </p>
<p>     * Let us know that the system is ready after startup. </p>
<p>     */  </p>
<p>public void onSystemReady() {  </p>
<p>        mSearchManager = (SearchManager) mContext.getSystemService(Context.SEARCH_SERVICE);  </p>
<p>synchronized (this) {  </p>
<p>if (DEBUG) Log.d(TAG, &quot;onSystemReady&quot;);  </p>
<p>            mSystemReady = true;  </p>
<p>            mUpdateMonitor.registerCallback(mUpdateCallback);  </p>
<p>// Suppress biometric unlock right after boot until things have settled if it is the  </p>
<p>// selected security method, otherwise unsuppress it.  It must be unsuppressed if it is  </p>
<p>// not the selected security method for the following reason:  if the user starts  </p>
<p>// without a screen lock selected, the biometric unlock would be suppressed the first  </p>
<p>// time they try to use it.  </p>
<p>//  </p>
<p>// Note that the biometric unlock will still not show if it is not the selected method.  </p>
<p>// Calling setAlternateUnlockEnabled(true) simply says don’t suppress it if it is the  </p>
<p>// selected method.  </p>
<p>if (mLockPatternUtils.usingBiometricWeak()  </p>
<p>                    &amp;&amp; mLockPatternUtils.isBiometricWeakInstalled()  </p>
<p>                    || mLockPatternUtils.usingVoiceWeak()  </p>
<p>                    &amp;&amp; FeatureOption.MTK_VOICE_UNLOCK_SUPPORT) {  </p>
<p>if (DEBUG) Log.d(TAG, &quot;suppressing biometric unlock during boot&quot;);  </p>
<p>                mUpdateMonitor.setAlternateUnlockEnabled(false);  </p>
<p>            } else {  </p>
<p>                mUpdateMonitor.setAlternateUnlockEnabled(true);  </p>
<p>            }  </p>
<p>/// M: power-off alarm @{  </p>
<p>if (!KeyguardUpdateMonitor.isAlarmBoot()) {  </p>
<p>                doKeyguardLocked();  </p>
<p>            }  </p>
<p>/// @}  </p>
<p>        }  </p>
<p>// Most services aren’t available until the system reaches the ready state, so we  </p>
<p>// send it here when the device first boots.  </p>
<p>        maybeSendUserPresentBroadcast();  </p>
<p>    }  </p>
<p>Step3：接着由doKeyguardLocked（）这个方法来做启动锁屏界面的预处理，来看看这个方法都做了什么：</p>
<p>[java] view plaincopyprint?</p>
<p>private void doKeyguardLocked() {  </p>
<p>    doKeyguardLocked(null);  </p>
<p>}  </p>
<p>/** </p>
<p> * Enable the keyguard if the settings are appropriate. </p>
<p> */  </p>
<p>private void doKeyguardLocked(Bundle options) {  </p>
<p>// if another app is disabling us, don’t show  </p>
<p>if (!mExternallyEnabled || KeyguardUpdateMonitor.isAlarmBoot()) {  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;doKeyguard: not showing because externally disabled&quot;);  </p>
<p>// note: we <em>should</em> set mNeedToReshowWhenReenabled=true here, but that makes  </p>
<p>// for an occasional ugly flicker in this situation:  </p>
<p>// 1) receive a call with the screen on (no keyguard) or make a call  </p>
<p>// 2) screen times out  </p>
<p>// 3) user hits key to turn screen back on  </p>
<p>// instead, we reenable the keyguard when we know the screen is off and the call  </p>
<p>// ends (see the broadcast receiver below)  </p>
<p>// TODO: clean this up when we have better support at the window manager level  </p>
<p>// for apps that wish to be on top of the keyguard  </p>
<p>return;  </p>
<p>    }  </p>
<p>// if the keyguard is already showing, don’t bother  </p>
<p>if (mKeyguardViewManager.isShowing()) {  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;doKeyguard: not showing because it is already showing&quot;);  </p>
<p>return;  </p>
<p>    }  </p>
<p>// if the setup wizard hasn’t run yet, don’t show  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;doKeyguard: get keyguard.no_require_sim property before&quot;);  </p>
<p>final boolean requireSim = !SystemProperties.getBoolean(&quot;keyguard.no_require_sim&quot;,  </p>
<p>false);  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;doKeyguard: get keyguard.no_require_sim property after&quot;);  </p>
<p>final boolean provisioned = mUpdateMonitor.isDeviceProvisioned();  </p>
<p>final IccCardConstants.State state = mUpdateMonitor.getSimState();  </p>
<p>boolean lockedOrMissing = false;  </p>
<p>/// M: Support GeminiPlus  </p>
<p>for (int i = PhoneConstants.GEMINI_SIM_1; i &lt;= KeyguardUtils.getMaxSimId(); i++) {  </p>
<p>        lockedOrMissing = (lockedOrMissing || isLockedOrMissingGemini(i, requireSim));  </p>
<p>if (lockedOrMissing) {  </p>
<p>break;  </p>
<p>        }  </p>
<p>    }  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;doKeyguard: get sim state after&quot;);  </p>
<p>/// M: MTK MOTA UPDATE when on ics2 keygaurd set none,update to JB,the keyguard will show LockScreen.  </p>
<p>/// MTK MOTA UPDATE when the phone first boot,check the settingDB mirged or not ,because mota update,  </p>
<p>/// the settingdb migrate slow than keygaurd(timing sequence problem) @{  </p>
<p>boolean keyguardDisable = false;  </p>
<p>/////*<strong><strong><strong><strong><strong><strong><strong><strong>****</strong></strong></strong></strong></strong></strong></strong></strong>TODO  </p>
<p>boolean motaUpdateFirst = true;//mLockPatternUtils.isDbMigrated();  </p>
<p>if (motaUpdateFirst) {  </p>
<p>/// DB mogi done  </p>
<p>        keyguardDisable = mLockPatternUtils.isLockScreenDisabled();  </p>
<p>    } else {  </p>
<p>/// DB not mogi  </p>
<p>final ContentResolver cr = mContext.getContentResolver();  </p>
<p>        String value = Settings.Secure.getString(cr, &quot;lockscreen.disabled&quot;);  </p>
<p>boolean booleanValue = false;  </p>
<p>if( null!=value ){  </p>
<p>            booleanValue = value.equals(&quot;1&quot;) ? true :false;  </p>
<p>        }  </p>
<p>        keyguardDisable = (!mLockPatternUtils.isSecure()) &amp;&amp; booleanValue;  </p>
<p>    }  </p>
<p>/// @}  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;doKeyguard: keyguardDisable query end&quot;);  </p>
<p>/// M: Add new condition DM lock is not true  </p>
<p>boolean dmLocked = KeyguardUpdateMonitor.getInstance(mContext).dmIsLocked();  </p>
<p>    KeyguardUtils.xlogD(TAG, &quot;lockedOrMissing is &quot; + lockedOrMissing + &quot;, requireSim=&quot; + requireSim  </p>
<p>        + &quot;, provisioned=&quot; + provisioned + &quot;, keyguardisable=&quot; + keyguardDisable + &quot;, dmLocked=&quot; + dmLocked);  </p>
<p>if (!lockedOrMissing &amp;&amp; !provisioned &amp;&amp; !dmLocked) {  </p>
<p>if (DEBUG) Log.d(TAG, &quot;doKeyguard: not showing because device isn’t provisioned&quot;  </p>
<p>                + &quot; and the sim is not locked or missing&quot;);  </p>
<p>return;  </p>
<p>    }  </p>
<p>/// M: Add a new condition DM lock is not on, or user can still bypass dm lock when Keygaurd is disabled  </p>
<p>if (mUserManager.getUsers(true).size() &lt; 2  </p>
<p>            &amp;&amp; keyguardDisable &amp;&amp; !lockedOrMissing &amp;&amp; !KeyguardUpdateMonitor.getInstance(mContext).dmIsLocked()) {  </p>
<p>if (DEBUG) Log.d(TAG, &quot;doKeyguard: not showing because lockscreen is off&quot;);  </p>
<p>return;  </p>
<p>    }  </p>
<p>if (DEBUG) Log.d(TAG, &quot;doKeyguard: showing the lock screen&quot;);  </p>
<p>    showLocked(options);  </p>
<p>}  </p>
<p>Step4、来注意最后调用的这个方法showLocked(options),这个方法是启动锁屏关键的方法，来看看：</p>
<p>[java] view plaincopyprint?</p>
<p>/** </p>
<p>    * Send message to keyguard telling it to show itself </p>
<p>    * @see #handleShow() </p>
<p>    */  </p>
<p>private void showLocked(Bundle options) {  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;showLocked&quot;);  </p>
<p>// ensure we stay awake until we are finished displaying the keyguard  </p>
<p>       mShowKeyguardWakeLock.acquire();  </p>
<p>       Message msg = mHandler.obtainMessage(SHOW, options);  </p>
<p>       mHandler.sendMessage(msg);  </p>
<p>   }  </p>
<p>Step5、这下就通过发送消息来进一步启动锁屏界面，来看看这个mHandler中的SHOW都做了什么：</p>
<p>[java] view plaincopyprint?</p>
<p>public void handleMessage(Message msg) {  </p>
<p>if (DBG_MESSAGE) KeyguardUtils.xlogD(TAG, &quot;handleMessage enter msg name=&quot; + getMessageString(msg));  </p>
<p>switch (msg.what) {  </p>
<p>case SHOW:  </p>
<p>                    handleShow((Bundle) msg.obj);  </p>
<p>break;  </p>
<p>调用的是handleShow()这个方法：</p>
<p>[java] view plaincopyprint?</p>
<p>/** </p>
<p>     * Handle message sent by {@link #showLocked}. </p>
<p>     * @see #SHOW </p>
<p>     */  </p>
<p>private void handleShow(Bundle options) {  </p>
<p>synchronized (KeyguardViewMediator.this) {  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;handleShow enter&quot;);  </p>
<p>if (!mSystemReady) return;  </p>
<p>/// M: if already showing, just return  </p>
<p>if (mShowing) return;  </p>
<p>            mKeyguardViewManager.show(options);  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;handleShow mKeyguardViewManager Show exit&quot;);  </p>
<p>            mShowing = true;  </p>
<p>            mKeyguardDonePending = false;  </p>
<p>            updateActivityLockScreenState();  </p>
<p>            adjustStatusBarLocked();  </p>
<p>            userActivity();  </p>
<p>try {  </p>
<p>                ActivityManagerNative.getDefault().closeSystemDialogs(&quot;lock&quot;);  </p>
<p>            } catch (RemoteException e) {  </p>
<p>            }  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;handleShow query AlarmBoot before&quot;);  </p>
<p>// Do this at the end to not slow down display of the keyguard.  </p>
<p>if (!KeyguardUpdateMonitor.isAlarmBoot()) {  </p>
<p>                playSounds(true);  </p>
<p>            } else {  </p>
<p>new Handler().postDelayed(new Runnable() {  </p>
<p>public void run() {  </p>
<p>                        sendRemoveIPOWinBroadcast();  </p>
<p>                        startAlarm();  </p>
<p>                    }  </p>
<p>                }, 250);  </p>
<p>            }  </p>
<p>            mShowKeyguardWakeLock.release();  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;handleShow exit&quot;);  </p>
<p>        }  </p>
<p>    }  </p>
<p>Step6、接着看mKeyguardViewManager.show(options);这个方法都干了什么：</p>
<p>[java] view plaincopyprint?</p>
<p>/** </p>
<p>    * Show the keyguard.  Will handle creating and attaching to the view manager </p>
<p>    * lazily. </p>
<p>    */  </p>
<p>public synchronized void show(Bundle options) {  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;show(); mKeyguardView=&quot; + mKeyguardView);  </p>
<p>boolean enableScreenRotation = shouldEnableScreenRotation();  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;show() query screen rotation after&quot;);  </p>
<p>/// M: Incoming Indicator for Keyguard Rotation @{  </p>
<p>       KeyguardUpdateMonitor.getInstance(mContext).setQueryBaseTime();  </p>
<p>/// @}  </p>
<p>       maybeCreateKeyguardLocked(enableScreenRotation, false, options);  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;show() maybeCreateKeyguardLocked finish&quot;);  </p>
<p>       maybeEnableScreenRotation(enableScreenRotation);  </p>
<p>// Disable common aspects of the system/status/navigation bars that are not appropriate or  </p>
<p>// useful on any keyguard screen but can be re-shown by dialogs or SHOW_WHEN_LOCKED  </p>
<p>// activities. Other disabled bits are handled by the KeyguardViewMediator talking  </p>
<p>// directly to the status bar service.  </p>
<p>final int visFlags = View.STATUS_BAR_DISABLE_HOME;  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;show:setSystemUiVisibility(&quot; + Integer.toHexString(visFlags)+&quot;)&quot;);  </p>
<p>       mKeyguardHost.setSystemUiVisibility(visFlags);  </p>
<p>       mViewManager.updateViewLayout(mKeyguardHost, mWindowLayoutParams);  </p>
<p>       mKeyguardHost.setVisibility(View.VISIBLE);  </p>
<p>       mKeyguardView.show();  </p>
<p>       mKeyguardView.requestFocus();  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;show() exit; mKeyguardView=&quot; + mKeyguardView);  </p>
<p>   }  </p>
<p>Step7,、这下终于看到如山真面目了，看里面的方法maybeCreateKeyguardLocked（）这个是真正起作用的地方：</p>
<p>[java] view plaincopyprint?</p>
<p>&lt;span style=&quot;font-size:18px;&quot;&gt;private void maybeCreateKeyguardLocked(boolean enableScreenRotation, boolean force,  </p>
<p>            Bundle options) {  </p>
<p>final boolean isActivity = (mContext instanceof Activity); // for test activity  </p>
<p>if (mKeyguardHost != null) {  </p>
<p>            mKeyguardHost.saveHierarchyState(mStateContainer);  </p>
<p>        }  </p>
<p>if (mKeyguardHost == null) {  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;keyguard host is null, creating it…&quot;);  </p>
<p>            mKeyguardHost = new ViewManagerHost(mContext);  </p>
<p>int flags = WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN  </p>
<p>                    | WindowManager.LayoutParams.FLAG_LAYOUT_INSET_DECOR  </p>
<p>                    | WindowManager.LayoutParams.FLAG_FORCE_NOT_FULLSCREEN  </p>
<p>                    | WindowManager.LayoutParams.FLAG_SHOW_WALLPAPER;  </p>
<p>/// M: Modify to support DM lock, hide statusbr when dm lock power on @{  </p>
<p>            KeyguardUpdateMonitor monitor = KeyguardUpdateMonitor.getInstance(mContext);  </p>
<p>if (monitor.dmIsLocked()) { //in the first created  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;show(); dmIsLocked &quot;);  </p>
<p>                flags &amp;= ~WindowManager.LayoutParams.FLAG_FORCE_NOT_FULLSCREEN;  </p>
<p>                flags |= WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN;  </p>
<p>                flags |= WindowManager.LayoutParams.FLAG_LAYOUT_INSET_DECOR;  </p>
<p>            } else if (KeyguardUpdateMonitor.isAlarmBoot()) {  </p>
<p>if (DEBUG) KeyguardUtils.xlogD(TAG, &quot;show(); AlarmBoot &quot;);  </p>
<p>                flags &amp;= ~WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN;  </p>
<p>                flags &amp;= ~WindowManager.LayoutParams.FLAG_LAYOUT_INSET_DECOR;  </p>
<p>                flags |= WindowManager.LayoutParams.FLAG_FORCE_NOT_FULLSCREEN;  </p>
<p>            }  </p>
<p>/// M: @}  </p>
<p>if (!mNeedsInput) {  </p>
<p>                flags |= WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM;  </p>
<p>            }  </p>
<p>if (ActivityManager.isHighEndGfx()) {  </p>
<p>                flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;  </p>
<p>            }  </p>
<p>final int stretch = ViewGroup.LayoutParams.MATCH_PARENT;  </p>
<p>final int type = isActivity ? WindowManager.LayoutParams.TYPE_APPLICATION  </p>
<p>                    : WindowManager.LayoutParams.TYPE_KEYGUARD;  </p>
<p>            WindowManager.LayoutParams lp = new WindowManager.LayoutParams(  </p>
<p>                    stretch, stretch, type, flags, PixelFormat.TRANSLUCENT);  </p>
<p>            lp.softInputMode = WindowManager.LayoutParams.SOFT_INPUT_ADJUST_RESIZE;  </p>
<p>            lp.windowAnimations = com.android.internal.R.style.Animation_LockScreen;  </p>
<p>if (ActivityManager.isHighEndGfx()) {  </p>
<p>                lp.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;  </p>
<p>                lp.privateFlags |=  </p>
<p>                        WindowManager.LayoutParams.PRIVATE_FLAG_FORCE_HARDWARE_ACCELERATED;  </p>
<p>            }  </p>
<p>            lp.privateFlags |= WindowManager.LayoutParams.PRIVATE_FLAG_SET_NEEDS_MENU_KEY;  </p>
<p>if (isActivity) {  </p>
<p>                lp.privateFlags |= WindowManager.LayoutParams.PRIVATE_FLAG_SHOW_FOR_ALL_USERS;  </p>
<p>            }  </p>
<p>/// M: Poke user activity when operating Keyguard  </p>
<p>//lp.inputFeatures |= WindowManager.LayoutParams.INPUT_FEATURE_DISABLE_USER_ACTIVITY;  </p>
<p>            lp.setTitle(isActivity ? &quot;KeyguardMock&quot; : &quot;Keyguard&quot;);  </p>
<p>            mWindowLayoutParams = lp;  </p>
<p>            mViewManager.addView(mKeyguardHost, lp);  </p>
<p>        }  </p>
<p>/// M: If force and keyguardView is not null, we should relase memory hold by old keyguardview  </p>
<p>if (force &amp;&amp; mKeyguardView != null) {  </p>
<p>            mKeyguardView.cleanUp();  </p>
<p>        }  </p>
<p>if (force || mKeyguardView == null) {  </p>
<p>            inflateKeyguardView(options);  </p>
<p>            mKeyguardView.requestFocus();  </p>
<p>        }  </p>
<p>        updateUserActivityTimeoutInWindowLayoutParams();  </p>
<p>        mViewManager.updateViewLayout(mKeyguardHost, mWindowLayoutParams);  </p>
<p>        mKeyguardHost.restoreHierarchyState(mStateContainer);  </p>
<p>    }&lt;/span&gt;  </p>
<p>这下通过 mViewManager.addView(mKeyguardHost, lp);这个方法真正地把锁屏界面添加到屏幕上，其实这个就是个view，挡在了手机的屏幕的最上方。而这个mKeyguardHost就是锁屏的根。而第一次加载的时候mKeyguardView为空，调用inflateKeyguardView（），初始化锁屏的view。</p>
<p>Step8、来看看这个inflateKeyguardView（）这个方法都加载了哪个布局：</p>
<p>[java] view plaincopyprint?</p>
<p>private void inflateKeyguardView(Bundle options) {  </p>
<p>/// M: add for power-off alarm @{  </p>
<p>int resId = R.id.keyguard_host_view;  </p>
<p>int layoutId = R.layout.keyguard_host_view;  </p>
<p>if(KeyguardUpdateMonitor.isAlarmBoot()){  </p>
<p>            layoutId = com.mediatek.internal.R.layout.power_off_alarm_host_view;  </p>
<p>            resId = com.mediatek.internal.R.id.keyguard_host_view;  </p>
<p>        }  </p>
<p>/// @}  </p>
<p>        View v = mKeyguardHost.findViewById(resId);  </p>
<p>if (v != null) {  </p>
<p>            mKeyguardHost.removeView(v);  </p>
<p>        }  </p>
<p>// TODO: Remove once b/7094175 is fixed  </p>
<p>if (false) Slog.d(TAG, &quot;inflateKeyguardView: b/7094175 mContext.config=&quot;  </p>
<p>                + mContext.getResources().getConfiguration());  </p>
<p>/// M: Save new orientation  </p>
<p>        mCreateOrientation = mContext.getResources().getConfiguration().orientation;  </p>
<p>final LayoutInflater inflater = LayoutInflater.from(mContext);  </p>
<p>        View view = inflater.inflate(layoutId, mKeyguardHost, true);  </p>
<p>        mKeyguardView = (KeyguardHostView) view.findViewById(resId);  </p>
<p>        mKeyguardView.setLockPatternUtils(mLockPatternUtils);  </p>
<p>        mKeyguardView.setViewMediatorCallback(mViewMediatorCallback);  </p>
<p>// HACK  </p>
<p>// The keyguard view will have set up window flags in onFinishInflate before we set  </p>
<p>// the view mediator callback. Make sure it knows the correct IME state.  </p>
<p>if (mViewMediatorCallback != null) {  </p>
<p>            KeyguardPasswordView kpv = (KeyguardPasswordView) mKeyguardView.findViewById(  </p>
<p>                    R.id.keyguard_password_view);  </p>
<p>if (kpv != null) {  </p>
<p>                mViewMediatorCallback.setNeedsInput(kpv.needsInput());  </p>
<p>            }  </p>
<p>        }  </p>
<p>/// Extract this block to a single function  </p>
<p>        updateKeyguardViewFromOptions(options);  </p>
<p>    }  </p>
<p>这个加载了keyguard_host_view这个layout，来看看这个布局是怎么写的：</p>
<p>[html] view plaincopyprint?</p>
<p>&lt;com.android.internal.policy.impl.keyguard.KeyguardHostView  </p>
<p>xmlns:android=&quot;<a target="_blank" rel="noopener" href="http://schemas.android.com/apk/res/android">http://schemas.android.com/apk/res/android</a>&quot;  </p>
<p>xmlns:androidprv=&quot;<a target="_blank" rel="noopener" href="http://schemas.android.com/apk/res/android">http://schemas.android.com/apk/res/android</a>&quot;  </p>
<p>android:id=&quot;@+id/keyguard_host_view&quot;  </p>
<p>android:layout_width=&quot;match_parent&quot;  </p>
<p>android:layout_height=&quot;match_parent&quot;  </p>
<p>android:gravity=&quot;center_horizontal&quot;  </p>
<p>android:orientation=&quot;vertical&quot;&gt;  </p>
<p>&lt;com.android.internal.policy.impl.keyguard.SlidingChallengeLayout  </p>
<p>android:id=&quot;@+id/sliding_layout&quot;  </p>
<p>android:layout_width=&quot;match_parent&quot;  </p>
<p>android:layout_height=&quot;match_parent&quot;&gt;  </p>
<p>&lt;FrameLayout  </p>
<p>android:layout_width=&quot;match_parent&quot;  </p>
<p>android:layout_height=&quot;match_parent&quot;  </p>
<p>androidprv:layout_childType=&quot;mediatekLayerBackground&quot;&gt;  </p>
<p>&lt;/FrameLayout&gt;  </p>
<p>&lt;FrameLayout  </p>
<p>android:layout_width=&quot;match_parent&quot;  </p>
<p>android:layout_height=&quot;wrap_content&quot;  </p>
<p>androidprv:layout_childType=&quot;pageDeleteDropTarget&quot;&gt;  </p>
<p>&lt;include layout=&quot;@layout/keyguard_widget_remove_drop_target&quot;  </p>
<p>android:id=&quot;@+id/keyguard_widget_pager_delete_target&quot;  </p>
<p>android:layout_width=&quot;wrap_content&quot;  </p>
<p>android:layout_height=&quot;wrap_content&quot;  </p>
<p>android:layout_gravity=&quot;top|center_horizontal&quot; /&gt;  </p>
<p>&lt;/FrameLayout&gt;  </p>
<p>&lt;FrameLayout  </p>
<p>android:layout_width=&quot;match_parent&quot;  </p>
<p>android:layout_height=&quot;match_parent&quot;  </p>
<p>androidprv:layout_childType=&quot;widgets&quot;&gt;  </p>
<p>&lt;include layout=&quot;@layout/keyguard_widget_pager&quot;  </p>
<p>android:id=&quot;@+id/app_widget_container&quot;  </p>
<p>android:layout_width=&quot;match_parent&quot;  </p>
<p>android:layout_height=&quot;match_parent&quot;  </p>
<p>android:layout_gravity=&quot;center&quot;/&gt;  </p>
<p>&lt;/FrameLayout&gt;  </p>
<p>&lt;View android:layout_width=&quot;match_parent&quot;  </p>
<p>android:layout_height=&quot;match_parent&quot;  </p>
<p>androidprv:layout_childType=&quot;scrim&quot;  </p>
<p>android:background=&quot;#99000000&quot; /&gt;  </p>
<p>&lt;FrameLayout  </p>
<p>android:layout_width=&quot;match_parent&quot;  </p>
<p>android:layout_height=&quot;match_parent&quot;  </p>
<p>androidprv:layout_childType=&quot;mediatekLayerForeground&quot;&gt;  </p>
<p>&lt;/FrameLayout&gt;  </p>
<p>&lt;com.android.internal.policy.impl.keyguard.KeyguardSecurityContainer  </p>
<p>android:id=&quot;@+id/keyguard_security_container&quot;  </p>
<p>android:layout_width=&quot;wrap_content&quot;  </p>
<p>android:layout_height=&quot;wrap_content&quot;  </p>
<p>android:layout_maxHeight=&quot;@dimen/keyguard_security_height&quot;  </p>
<p>androidprv:layout_childType=&quot;challenge&quot;  </p>
<p>android:padding=&quot;0dp&quot;  </p>
<p>android:gravity=&quot;bottom|center_horizontal&quot;&gt;  </p>
<p>&lt;com.android.internal.policy.impl.keyguard.KeyguardSecurityViewFlipper  </p>
<p>android:id=&quot;@+id/view_flipper&quot;  </p>
<p>android:layout_width=&quot;match_parent&quot;  </p>
<p>android:layout_height=&quot;match_parent&quot;  </p>
<p>android:clipToPadding=&quot;false&quot;  </p>
<p>android:paddingTop=&quot;@dimen/keyguard_security_view_margin&quot;  </p>
<p>android:gravity=&quot;center&quot;&gt;  </p>
<p>&lt;/com.android.internal.policy.impl.keyguard.KeyguardSecurityViewFlipper&gt;  </p>
<p>&lt;/com.android.internal.policy.impl.keyguard.KeyguardSecurityContainer&gt;  </p>
<p>&lt;ImageButton  </p>
<p>android:layout_width=&quot;match_parent&quot;  </p>
<p>android:layout_height=&quot;@dimen/kg_widget_pager_bottom_padding&quot;  </p>
<p>androidprv:layout_childType=&quot;expandChallengeHandle&quot;  </p>
<p>android:focusable=&quot;true&quot;  </p>
<p>android:background=&quot;@null&quot;  </p>
<p>android:src=&quot;@drawable/keyguard_expand_challenge_handle&quot;  </p>
<p>android:scaleType=&quot;center&quot;  </p>
<p>android:contentDescription=&quot;@string/keyguard_accessibility_expand_lock_area&quot; /&gt;  </p>
<p>&lt;/com.android.internal.policy.impl.keyguard.SlidingChallengeLayout&gt;  </p>
<p>&lt;/com.android.internal.policy.impl.keyguard.KeyguardHostView&gt;  </p>
<p>而这个KeyguardHostView.java就是锁屏的真正的处理的view，该添加什么样的锁屏，例如：PIN，Pattern，PUK，Password等等，都是由它来控制的，最后会调用到getLayoutIdFor（）这个方法，来启动那种锁屏界面，如下：</p>
<p>[java] view plaincopyprint?</p>
<p>private int getLayoutIdFor(SecurityMode securityMode) {  </p>
<p>switch (securityMode) {  </p>
<p>case None: return R.layout.keyguard_selector_view;  </p>
<p>case Pattern: return R.layout.keyguard_pattern_view;  </p>
<p>case PIN: return R.layout.keyguard_pin_view;  </p>
<p>case Password: return R.layout.keyguard_password_view;  </p>
<p>case Biometric: return R.layout.keyguard_face_unlock_view;  </p>
<p>case Account: return R.layout.keyguard_account_view;  </p>
<p>/// M: Modify Sim unlock layout @{  </p>
<p>//case SimPin: return R.layout.keyguard_sim_pin_view;  </p>
<p>//case SimPuk: return R.layout.keyguard_sim_puk_view;  </p>
<p>case SimPinPukMe1: return com.mediatek.internal.R.layout.keyguard_sim_pin_puk_view;  </p>
<p>case SimPinPukMe2: return com.mediatek.internal.R.layout.keyguard_sim_pin_puk_view;  </p>
<p>/// M: Support GeminiPlus  </p>
<p>case SimPinPukMe3: return com.mediatek.internal.R.layout.keyguard_sim_pin_puk_view;  </p>
<p>case SimPinPukMe4: return com.mediatek.internal.R.layout.keyguard_sim_pin_puk_view;  </p>
<p>/// @}  </p>
<p>/// M: power-off alarm @{  </p>
<p>case AlarmBoot: return com.mediatek.internal.R.layout.power_off_alarm_view;  </p>
<p>/// @}  </p>
<p>///M: add voice unlock view layout  </p>
<p>case Voice: return R.layout.zz_keyguard_voice_unlock_view;  </p>
<p>default:  </p>
<p>return 0;  </p>
<p>        }  </p>
<p>    }  </p>
<p>到这，锁屏已经初始化完了，要想下面接着分析，估计大家应该都能分析过去了；</p>
<p>特别说明：</p>
<p>1、加载锁屏widget的地方在KeyguardHostView.java的onFinishInflate()中，调用的addDefaultWidget()这个方法中添加了单click事件，最后调用到KeyguardActivityLauncher.java的launcherWidgetPicker()这个方法；</p>
<p>2、要想你写的widget能被锁屏widget过滤出来，只需要在wdget的xml中添加一个属性即可：</p>
<p>android:widgetCategory=&quot;home_screen|keyguard&quot;，这样你写的桌面widget，也能在锁屏wiget过滤出来，具体布局需要你微调下；</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/12/31/%E7%83%82%E7%AC%94%E5%A4%B4/%E5%9B%9B%E8%B1%A1%E9%99%90%E6%B3%95%E5%88%99/" rel="prev" title="四象限法则">
      <i class="fa fa-chevron-left"></i> 四象限法则
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/12/31/%E7%83%82%E7%AC%94%E5%A4%B4/%E6%B7%BB%E5%8A%A03g_support_list%20%E8%AE%BE%E7%BD%AE/" rel="next" title="添加3g_support_list 设置">
      添加3g_support_list 设置 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Edward"
      src="/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">Edward</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">554</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Edward</span>
</div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"wxYx0BX9gaKA3XC4LuO2of0v-gzGzoHsz","app_key":"LQMcs6IDIE4YAm10vMsn9IYq","server_url":"https://wxyx0bx9.lc-cn-n1-shared.com","security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
